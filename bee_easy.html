<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>꿀벌 Easy - 두근두근 개체군 키우기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #ffd89b 0%, #19547b 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.03) 0px,
                rgba(255, 255, 255, 0.03) 2px,
                transparent 2px,
                transparent 12px
            );
            pointer-events: none;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-container {
            width: 100vw;
            height: 56.25vw;
            max-width: 1280px;
            max-height: 720px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2em;
            box-shadow: 
                0 0 0 3px rgba(255, 255, 255, 0.2),
                0 1.5em 4em rgba(0, 0, 0, 0.2),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(0.6em);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: calc(1vw + 0.5vh);
        }

        @media (min-width: 1280px) {
            .game-container {
                font-size: 16px;
            }
        }

        @media screen and (min-aspect-ratio: 16/9) {
            .game-container {
                width: 177.78vh;
                height: 100vh;
            }
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1em 2em;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(0.3em);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(0, 0, 0, 0.15);
        }

        .status-info {
            display: flex;
            gap: 1em;
            align-items: center;
        }

        .status-display {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5em 1em;
            border-radius: 1em;
            font-weight: 700;
            color: #2D3748;
            font-size: 0.9em;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .graph-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 0.8em;
            padding: 0.5em 1em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            box-shadow: 0 0.25em 0.75em rgba(72, 187, 120, 0.3);
        }

        .graph-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(72, 187, 120, 0.4);
        }

        .graph-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .character-area {
            position: absolute;
            top: 4em;
            bottom:  4em;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1em 2em;
			
			background-image: url('images/bee_background.png');
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
        }

        .character {
            width: 18em;
            height: 18em;
            background-image: url('images/bee_main.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            animation: bounce 2s ease-in-out infinite;
            filter: drop-shadow(0 0.4em 1em rgba(0, 0, 0, 0.15));
            transition: background-image 0.5s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) rotate(0deg); }
            40% { transform: translateY(-0.8em) rotate(-2deg); }
            60% { transform: translateY(-0.4em) rotate(1deg); }
        }

        .dialogue-container {
            position: absolute;
            bottom: 2em;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5em 1.5em 1.5em 1.5em;
            padding: 1.5em;
            /*  min-height: 8em; */
            box-shadow: 
                0 -0.4em 1.2em rgba(0, 0, 0, 0.1),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
        }

        .dialogue-text {
            font-size: 1em;
            line-height: 1.5;
            color: #2D3748;
            margin-bottom: 1em;
            min-height: 3.5em;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .dialogue-text.success {
            color: #22c55e;
            font-weight: 600;
        }

        .dialogue-actions {
            display: flex;
            gap: 0.8em;
            justify-content: flex-end;
            align-items: center;
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0.3em 0.8em rgba(102, 126, 234, 0.3),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.2);
        }

        .next-btn:hover:not(:disabled) {
            transform: translateY(-0.12em) scale(1.05);
            box-shadow: 
                0 0.75em 1.5em rgba(102, 126, 234, 0.4),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.3);
        }
        
        .next-btn:disabled {
            cursor: not-allowed;
            background: #ccc;
        }

        .action-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 1.2em;
            padding: 0.8em 1.5em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            box-shadow: 0 0.37em 0.9em rgba(72, 187, 120, 0.3);
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.5em 1.2em rgba(72, 187, 120, 0.4);
        }

        .action-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            box-shadow: 0 0.37em 0.9em rgba(159, 122, 234, 0.3);
        }

        .action-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 0.5em 1.2em rgba(159, 122, 234, 0.4);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 0.37em 0.9em rgba(229, 62, 62, 0.3);
        }

        .action-btn.danger:hover:not(:disabled) {
            box-shadow: 0 0.5em 1.2em rgba(229, 62, 62, 0.4);
        }

        /* 입력창 스타일 */
        .food-input-container {
            display: flex;
            align-items: center;
            gap: 0.5em;
            margin: 1em 0;
        }

        .food-input {
            padding: 0.5em;
            border: 2px solid #cbd5e0;
            border-radius: 0.5em;
            font-size: 1em;
            width: 6em;
            text-align: center;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border: none;
            border-radius: 0.8em;
            padding: 0.5em 1em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .confirm-btn:hover {
            transform: translateY(-0.06em);
        }

        /* 이벤트 모달 */
        .event-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .event-content {
            background: white;
            padding: 2em;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 35em;
            max-height: 80%;
        }

        /* 선택형 이벤트 모달 스타일 */
        .choice-event-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .choice-event-content {
            background: white;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 50em;
            height: 80%;
            max-height: 35em;
            display: flex;
            overflow: hidden;
        }

        .choice-event-image {
            flex: 1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 1.5em 0 0 1.5em;
        }

        .choice-event-right {
            flex: 1;
            padding: 2em;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .choice-event-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #2D3748;
            margin-bottom: 1.5em;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 1em;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .choice-buttons.show {
            opacity: 1;
        }

        .choice-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border: none;
            border-radius: 1em;
            padding: 1em 1.5em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            text-align: left;
        }

        .choice-btn:hover {
            transform: translateY(-0.06em);
            box-shadow: 0 0.5em 1.2em rgba(66, 153, 225, 0.4);
        }

        .choice-btn:nth-child(2) {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .choice-btn:nth-child(2):hover {
            box-shadow: 0 0.5em 1.2em rgba(72, 187, 120, 0.4);
        }

        .event-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #2D3748;
            margin-bottom: 1.5em;
            min-height: 4em;
        }

        .event-text.positive {
            color: #2563eb;
        }

        .event-text.negative {
            color: #dc2626;
        }

        .event-next-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 50%;
            width: 3em;
            height: 3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .event-next-btn:hover {
            transform: scale(1.1);
        }

        /* 미니게임 영역 */
        .minigame-area {
            position: relative;
            width: 100%;
            height: 20em;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: 1em;
            margin: 1em 0;
            overflow: hidden;
            border: 2px solid #f59e0b;
        }

        .bee-emoji {
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 3em;
            transition: all 0.3s ease;
            z-index: 3;
        }

        .hive-emoji {
            position: absolute;
            bottom: 10%;
            right: 10%;
            font-size: 4em;
            z-index: 2;
        }

        .direction-controls {
            position: absolute;
            bottom: 1em;
            left: 1em;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0.5em;
            width: 8em;
            height: 8em;
        }

        .direction-btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: none;
            border-radius: 0.5em;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 1.5em;
            transition: all 0.3s ease;
            box-shadow: 0 0.25em 0.5em rgba(245, 158, 11, 0.4);
        }

        .direction-btn:hover {
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 0.75em rgba(245, 158, 11, 0.5);
        }

        .direction-btn:nth-child(2) { grid-column: 2; grid-row: 1; } /* 상 */
        .direction-btn:nth-child(1) { grid-column: 1; grid-row: 2; } /* 좌 */
        .direction-btn:nth-child(3) { grid-column: 3; grid-row: 2; } /* 우 */
        .direction-btn:nth-child(4) { grid-column: 2; grid-row: 3; } /* 하 */

        .timer-display {
            position: absolute;
            top: 1em;
            right: 1em;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5em 1em;
            border-radius: 1em;
            font-size: 1.5em;
            font-weight: 700;
        }

        /* 그래프 모달 */
        .graph-modal, .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .history-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .graph-content, .loading-content {
            background: white;
            padding: 2em;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .graph-content { 
            width: 90%; 
            max-width: 35em; 
            max-height: 80%;
        }
        
        .loading-content { 
            text-align: center; 
            font-size: 2em; 
            font-weight: 700; 
            color: #2D3748; 
            padding: 2em;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
        }

        .graph-title { 
            font-size: 1.3em; 
            font-weight: 700; 
            color: #2D3748; 
        }

        .close-btn {
            background: #e53e3e; 
            border: none; 
            border-radius: 50%; 
            width: 2em; 
            height: 2em;
            color: white; 
            cursor: pointer; 
            font-size: 1.2em; 
            transition: all 0.3s ease;
        }
        
        .close-btn:hover { 
            background: #c53030; 
            transform: scale(1.1); 
        }

        .history-content {
            max-height: 300px; 
            overflow-y: auto; 
            padding: 1em; 
            background: #f7fafc; 
            border-radius: 0.5em; 
            font-family: monospace; 
            line-height: 1.5;
            white-space: pre-line;
        }

        .typing-cursor { 
            animation: blink 1s infinite; 
        }
        
        @keyframes blink { 
            0%, 50% { opacity: 1; } 
            51%, 100% { opacity: 0; } 
        }

        /* 게임 결과 애니메이션 */
        .result-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: 900;
            text-align: center;
            z-index: 100;
            animation: resultPop 2s ease-out;
            pointer-events: none;
        }

        .result-animation.success {
            color: #22c55e;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .result-animation.failure {
            color: #ef4444;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        @keyframes resultPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1.1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="status-bar">
            <button class="back-btn" id="backBtn">←</button>
            <div class="status-info" id="statusInfo">
                <div class="status-display" id="yearDisplay">0년차</div>
                <div class="status-display" id="populationDisplay">개체수: 50마리</div>
                <div class="status-display" id="plantADisplay">밀원식물A: -그루</div>
                <div class="status-display" id="plantBDisplay">밀원식물B: -그루</div>
                <button class="graph-btn" id="graphBtn" disabled>개체수 그래프</button>
            </div>
        </div>

        <div class="character-area" id="characterArea">
            <div class="character" id="character"></div>
        </div>

        <div class="dialogue-container" id="dialogueContainer">
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-actions" id="dialogueActions">
                <button class="next-btn" id="nextBtn">🔽</button>
            </div>
        </div>

        <!-- 기존 이벤트 모달 (알림형) -->
        <div class="event-modal" id="eventModal">
            <div class="event-content">
                <div class="event-text" id="eventText"></div>
                <div id="eventActions">
                    <button class="event-next-btn" id="eventNextBtn">▼</button>
                </div>
            </div>
        </div>

        <!-- 새로운 선택형 이벤트 모달 -->
        <div class="choice-event-modal" id="choiceEventModal">
            <div class="choice-event-content">
                <div class="choice-event-image" id="choiceEventImage"></div>
                <div class="choice-event-right">
                    <div class="choice-event-text" id="choiceEventText"></div>
                    <div class="choice-buttons" id="choiceButtons">
                        <button class="choice-btn" id="choice1Btn"></button>
                        <button class="choice-btn" id="choice2Btn"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 그래프 모달 -->
        <div class="graph-modal" id="graphModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">개체수 변화 그래프</div>
                    <button class="close-btn" id="closeGraphBtn">×</button>
                </div>
                <canvas class="graph-canvas" id="graphCanvas" style="width: 100%; height: 20em; border: 1px solid #e2e8f0; border-radius: 0.5em;"></canvas>
            </div>
        </div>

        <!-- 히스토리 모달 -->
        <div class="history-modal" id="historyModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">히스토리</div>
                    <button class="close-btn" id="closeHistoryBtn">×</button>
                </div>
                <div class="history-content" id="historyContent"></div>
            </div>
        </div>

        <!-- 로딩 모달 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content" id="loadingText">시간이 흐르고 있어...</div>
        </div>
    </div>

    <script>
        // 게임 상태
        let gameState = {
            currentYear: 0,
            population: 50,
            plantA: 0, // 밀원식물A 개체수
            plantB: 0, // 밀원식물B 개체수
            populationHistory: [50],
            plantAHistory: [],
            plantBHistory: [],
            historyEvents: [],
            dialogueStep: 0,
            isTyping: false,
            gameEnded: false,
            dialogueComplete: false
        };

        // DOM 요소들
        const dialogueTextEl = document.getElementById('dialogueText');
        const dialogueActionsEl = document.getElementById('dialogueActions');
        const characterEl = document.getElementById('character');
        const yearDisplayEl = document.getElementById('yearDisplay');
        const populationDisplayEl = document.getElementById('populationDisplay');
        const plantADisplayEl = document.getElementById('plantADisplay');
        const plantBDisplayEl = document.getElementById('plantBDisplay');
        const graphBtnEl = document.getElementById('graphBtn');
        const backBtnEl = document.getElementById('backBtn');
        const eventModalEl = document.getElementById('eventModal');
        const eventTextEl = document.getElementById('eventText');
        const eventActionsEl = document.getElementById('eventActions');
        const choiceEventModalEl = document.getElementById('choiceEventModal');
        const choiceEventImageEl = document.getElementById('choiceEventImage');
        const choiceEventTextEl = document.getElementById('choiceEventText');
        const choiceButtonsEl = document.getElementById('choiceButtons');
        const graphModalEl = document.getElementById('graphModal');
        const historyModalEl = document.getElementById('historyModal');
        const loadingOverlayEl = document.getElementById('loadingOverlay');
        const historyContentEl = document.getElementById('historyContent');

        // 초기 대사
        const initialDialogues = [
            "왱왱. 나는 귀여운 꿀벌이야.",
            "나는 꽃가루를 먹어서 단백질을 보충하고, 꿀을 먹어서 탄수화물을 보충해.",
            "우리에게 꽃가루와 꿀을 수분해주는 고마운 식물들을 '밀원식물'이라고 불러.",
            "밀원식물은 우리 덕분에 수분이 이루어져 열매를 맺을 수 있으니, 우리는 서로 돕는 관계지!",
            "과연 현실에서도 우리 개체군은 계속 성장해나갈 수 있을까?",
            "우리 꿀벌 개체군은 지금 50마리가 있어.",
            "그리고 우리 벌집 근처 밀원 식물은 크게 두 종이 있어.",
            "밀원 식물 A는 얼마나 많이 꽃을 피우고 있을까?"
        ];

        // 효과음 함수
        const audioFiles = {
            positive: new Audio('audio/positive.mp3'),
            negative: new Audio('audio/negative.mp3'),
            success: new Audio('audio/success.mp3'),
            failure: new Audio('audio/failure.mp3'),
            lostBeeGame: new Audio('audio/lost_bee_game.mp3')
        };

        // 길치 꿀벌 게임 음악은 루프 설정
        audioFiles.lostBeeGame.loop = true;

        // 모든 오디오 파일 미리 로드
        Object.values(audioFiles).forEach(audio => {
            audio.preload = 'auto';
        });

        // 효과음 재생 함수들
        function playPositiveSound() {
            audioFiles.positive.currentTime = 0;
            audioFiles.positive.play().catch(e => console.log('긍정 효과음 재생 오류:', e));
        }

        function playNegativeSound() {
            audioFiles.negative.currentTime = 0;
            audioFiles.negative.play().catch(e => console.log('부정 효과음 재생 오류:', e));
        }

        function playSuccessSound() {
            audioFiles.success.currentTime = 0;
            audioFiles.success.play().catch(e => console.log('성공 효과음 재생 오류:', e));
        }

        function playFailureSound() {
            audioFiles.failure.currentTime = 0;
            audioFiles.failure.play().catch(e => console.log('실패 효과음 재생 오류:', e));
        }

        function playLostBeeGameSound() {
            audioFiles.lostBeeGame.currentTime = 0;
            audioFiles.lostBeeGame.play().catch(e => console.log('길치 꿀벌 게임 음악 재생 오류:', e));
        }

        function stopLostBeeGameSound() {
            audioFiles.lostBeeGame.pause();
            audioFiles.lostBeeGame.currentTime = 0;
        }

        // 타이핑 애니메이션
        function typeText(element, text, callback, className = '') {
            if (gameState.isTyping) return;
            
            gameState.isTyping = true;
            if (className) {
                element.className = className;
            }
            element.innerHTML = '';
            let i = 0;
            const cursor = '<span class="typing-cursor">|</span>';
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + cursor;
                    i++;
                    setTimeout(type, 50);
                } else {
                    element.innerHTML = text;
                    gameState.isTyping = false;
                    if (callback) callback();
                }
            }
            type();
        }

        // 대사 진행
        function nextDialogue() {
            if (gameState.isTyping) return;
            
            if (gameState.dialogueStep < initialDialogues.length) {
                typeText(dialogueTextEl, initialDialogues[gameState.dialogueStep], () => {
                    // 밀원식물 A 입력창 표시
                    if (gameState.dialogueStep === initialDialogues.length) {
                        showPlantAInput();
                    }
                });
                gameState.dialogueStep++;
            } else if (gameState.dialogueStep === initialDialogues.length) {
                // 밀원식물A 설정 후
                const afterPlantAText = `지금 밀원식물 A ${gameState.plantA}그루로부터 꽃가루와 꿀을 얻을 수 있구나!`;
                typeText(dialogueTextEl, afterPlantAText, () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 1) {
                typeText(dialogueTextEl, "그렇다면 밀원 식물 B는 얼마나 많이 꽃을 피우고 있을까?", () => {
                    showPlantBInput();
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 2) {
                // 밀원식물B 설정 후
                const afterPlantBText = `지금 밀원식물 B ${gameState.plantB}그루로부터 꽃가루와 꿀을 얻을 수 있구나!`;
                typeText(dialogueTextEl, afterPlantBText, () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 3) {
                typeText(dialogueTextEl, "어떤 어려움이 찾아올지 모르겠지만, 내 벌생의 목표는!", () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 4) {
                typeText(dialogueTextEl, "우리 꿀벌 개체군이 안정적으로 잘 유지되는 거야. 그럴 수 있도록 도와줘! 잘 부탁해!", () => {
                    gameState.dialogueComplete = true;
                    showGameActions();
                    enableButtons();
                });
            }
        }

        // 밀원식물A 입력창 표시
        function showPlantAInput() {
            dialogueActionsEl.innerHTML = `
                <div class="food-input-container">
                    <span>밀원식물A 개체수:</span>
                    <input type="number" id="plantAInput" class="food-input" min="1" max="500" placeholder="1-500">
                    <button class="confirm-btn" onclick="setPlantACount()">확인</button>
                </div>
            `;
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.style.display = 'none';
            }
        }

        // 밀원식물B 입력창 표시
        function showPlantBInput() {
            dialogueActionsEl.innerHTML = `
                <div class="food-input-container">
                    <span>밀원식물B 개체수:</span>
                    <input type="number" id="plantBInput" class="food-input" min="1" max="500" placeholder="1-500">
                    <button class="confirm-btn" onclick="setPlantBCount()">확인</button>
                </div>
            `;
        }

        // 밀원식물A 개체수 설정
        function setPlantACount() {
            const plantAInput = document.getElementById('plantAInput');
            const value = parseInt(plantAInput.value);
            
            if (isNaN(value) || value < 1 || value > 500) {
                alert('1~500 범위 내에서 설정해주세요!');
                return;
            }
            
            gameState.plantA = value;
            gameState.plantAHistory = [value];
            updateDisplay();
            
            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">🔽</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            nextDialogue();
        }

        // 밀원식물B 개체수 설정
        function setPlantBCount() {
            const plantBInput = document.getElementById('plantBInput');
            const value = parseInt(plantBInput.value);
            
            if (isNaN(value) || value < 1 || value > 500) {
                alert('1~500 범위 내에서 설정해주세요!');
                return;
            }
            
            gameState.plantB = value;
            gameState.plantBHistory = [value];
            updateDisplay();
            
            // dialogueStep을 증가시켜서 다음 대화로 진행
            gameState.dialogueStep++; // 이 부분이 빠져있었음!
            
            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">🔽</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            nextDialogue();
        }

        // 게임 액션 버튼 표시
        function showGameActions() {
            dialogueActionsEl.innerHTML = `
                <button class="action-btn" id="nextYearBtn">1년 후~</button>
                <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
            `;
            document.getElementById('nextYearBtn').addEventListener('click', nextYear);
            document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
        }

        // 1년 진행
        function nextYear() {
            if (!gameState.dialogueComplete || gameState.gameEnded) return;
            
            showLoading();
            setTimeout(() => {
                gameState.currentYear++;
                
                // 이벤트 확인
                if (gameState.currentYear === 5) {
                    // 5년차 인간 이벤트
                    hideLoading();
                    showHumanEvent();
                    return;
                } else if (gameState.currentYear === 7) {
                    // 7년차 길치 꿀벌 이벤트
                    hideLoading();
                    showLostBeeEvent();
                    return;
                }
                
                // 기본 생태계 시뮬레이션
                simulateEcosystem();
                
                // 게임 종료 조건 확인
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else if (gameState.currentYear >= 10) {
                    showSuccessEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
                hideLoading();
            }, 1500);
        }

        // 생태계 시뮬레이션
        function simulateEcosystem() {
            const prevPopulation = gameState.population;
            const totalFood = gameState.plantA + gameState.plantB;
            
            // 로지스틱 성장 모델: dN/dt = N * (K - N) * a
            const K = totalFood * 0.8; // 환경수용력
            const a = 0.01; // 성장률
            
            let newPopulation = gameState.population + gameState.population * (K - gameState.population) * a;
            
            // 먹이가 부족한 경우 지수적 감소
            if (totalFood < gameState.population * 2) {
                newPopulation = gameState.population * 0.85; // 15% 감소
                gameState.historyEvents.push(`${gameState.currentYear}년차: 먹이 부족으로 개체군 위기`);
            }
            
            // 경계 조건
            newPopulation = Math.max(0, newPopulation);
            gameState.population = newPopulation;
            
            // 꿀벌 개체수 변화에 따른 식물 개체수 변화
            const populationChange = newPopulation / prevPopulation;
            
            if (populationChange > 1) {
                // 꿀벌 증가 시 식물도 증가 (수분 효과)
                gameState.plantA = Math.min(1000, gameState.plantA * Math.pow(populationChange, 0.5));
                gameState.plantB = Math.min(1000, gameState.plantB * Math.pow(populationChange, 0.5));
            } else {
                // 꿀벌 감소 시 식물도 감소
                gameState.plantA = gameState.plantA * populationChange;
                gameState.plantB = gameState.plantB * populationChange;
            }
            
            // 히스토리 업데이트
            gameState.populationHistory.push(gameState.population);
            gameState.plantAHistory.push(gameState.plantA);
            gameState.plantBHistory.push(gameState.plantB);
        }

        // 연차별 대사 표시
        function showYearlyDialogue() {
            const currentPop = Math.floor(gameState.population);
            const prevPop = Math.floor(gameState.populationHistory[gameState.currentYear - 1] || currentPop);
            
            let dialogue = `지금은 ${gameState.currentYear}년차고, 우리 꿀벌 개체군은 ${currentPop}마리가 되었어.`;
            
            if (currentPop >= prevPop) {
                dialogue += " 다행히 아직 우리 꿀벌 개체군은 잘 살아있어. 앞으로도 잘 부탁해.";
                characterEl.style.backgroundImage = "url('images/bee_happy.png')";
            } else {
                dialogue += " 나는 아직 살아있지만.. 친구와 가족들을 조금 잃었어. 🥺";
                characterEl.style.backgroundImage = "url('images/bee_sad.png')";
            }
            
            dialogueActionsEl.innerHTML = '';
            
            typeText(dialogueTextEl, dialogue, () => {
                setTimeout(() => {
                    showGameActions();
                }, 200);
            });
        }

        // 인간 이벤트 (5년차)
        function showHumanEvent() {
            choiceEventImageEl.style.backgroundImage = "url('images/bee_event_human.png')";
            
            typeText(choiceEventTextEl, "인간들이 꿀벌 개체군 보존을 위해 다음 중 하나를 시도하려고 한다. 무엇이 더 솔깃한가?", () => {
                choiceButtonsEl.classList.add('show');
            });
            
            document.getElementById('choice1Btn').textContent = "양봉장을 통해 안전한 곳에서 꿀벌을 기른다.";
            document.getElementById('choice2Btn').textContent = "꿀벌 서식지에 꿀벌 전염병을 일으키는 응애(진드기) 살충제를 뿌린다.";
            
            document.getElementById('choice1Btn').onclick = () => chooseHumanOption(1);
            document.getElementById('choice2Btn').onclick = () => chooseHumanOption(2);
            
            choiceEventModalEl.style.display = 'flex';
        }

        function chooseHumanOption(choice) {
            choiceEventModalEl.style.display = 'none';
			eventActionsEl.innerHTML = '';
			
  eventTextEl.textContent = '';
            eventModalEl.style.display = 'flex';

            if (choice === 1) {
                // 양봉장 선택
                playPositiveSound();
                const successTexts = [
                    "양봉장에서 인간들의 관리를 받으며 위협적인 환경으로부터 보호받았다!",
                    "[효과] 꿀벌 개체수 15% 증가"
                ];
                
                gameState.population *= 1.15; // 15% 증가
                gameState.historyEvents.push(`${gameState.currentYear}년차: 양봉장 관리 성공으로 꿀벌 개체수 15% 증가`);
                showEventResults(successTexts, true);
            } else {
                // 살충제 선택
                playPositiveSound();
                const successTexts = [
                    "인간들이 우리가 자주 다니는 식물에 해충 방제 작업을 했다고 한다.",
                    "듣기로는 옆 동네 꿀벌들은 응애가 기생하는 전염병 때문에 날지 못하는 기형이 많아졌다는데…",
                    "우리 개체군은 당분간 안심할 수 있을 것 같다!! …응애가 살충제 내성이 생기기 전까진…",
                    "[효과] 건강한 꿀벌들이 먹이를 열심히 날라, 다음 연차 꿀벌 수 25% 증가"
                ];
                
                gameState.population *= 1.25; // 25% 증가
                gameState.historyEvents.push(`${gameState.currentYear}년차: 응애 방제 작업으로 건강해진 꿀벌들이 먹이를 열심히 날라, 다음 연차 꿀벌 개체수 25% 증가`);
                showEventResults(successTexts, true);
            }
        }

        // 길치 꿀벌 이벤트 (7년차)
        function showLostBeeEvent() {
            // 길치 꿀벌 이벤트 시작과 함께 배경음악 재생
            playLostBeeGameSound();
            
            const eventSteps = [
                "인간들이 소나무숲을 해충으로부터 보존하려고 농약을 엄청나게 뿌리기 시작했다.",
                "소나무들은 덕분에 요즘 살맛난다고 한다……그런데!!",
                "농약의 네오니코티노이드 성분이 착한 우리 꿀벌들의 신경계를 고장냈다…",
                "매일 가던 집도 찾아가기 힘들다…우리 꿀벌 개체군은 단체로 길치 꿀벌이 되어버렸다ㅠㅠ",
                "[미션] 집 가는 길을 찾아라!",
                "'방향키' 버튼을 눌러 집 가는 길을 찾아주자."
            ];
            
            let currentStep = 0;
            
            function showEventStep() {
                if (currentStep < eventSteps.length) {
                    // 부정적인 이벤트이므로 negative 클래스 적용
                    eventTextEl.className = 'event-text negative';
                    typeText(eventTextEl, eventSteps[currentStep], () => {
                        currentStep++;
                        if (currentStep < eventSteps.length) {
                            eventActionsEl.innerHTML = `<button class="event-next-btn" onclick="showEventStep()">▼</button>`;
                        } else {
                            startLostBeeMinigame();
                        }
                    });
                }
            }
            
            eventActionsEl.innerHTML = '';
            eventModalEl.style.display = 'flex';
            showEventStep();
            
            window.showEventStep = showEventStep;
        }

        // 길치 꿀벌 미니게임
        function startLostBeeMinigame() {
            gameState.lostBeeGameEnded = false;
            
            eventActionsEl.innerHTML = `
                <div class="minigame-area">
                    <div class="bee-emoji" id="beeEmoji">🐝</div>
                    <div class="hive-emoji" id="hiveEmoji">🍯</div>
                    <div class="timer-display" id="timerDisplay">60</div>
                    <div class="direction-controls">
                        <button class="direction-btn" id="leftBtn">←</button>
                        <button class="direction-btn" id="upBtn">↑</button>
                        <button class="direction-btn" id="rightBtn">→</button>
                        <button class="direction-btn" id="downBtn">↓</button>
                    </div>
                </div>
            `;
            
            const beeEl = document.getElementById('beeEmoji');
            const hiveEl = document.getElementById('hiveEmoji');
            const timerEl = document.getElementById('timerDisplay');
            
            let beePosition = { x: 10, y: 10 }; // 퍼센트 단위
            let timeLeft = 60;
            let gameInterval;
            
            // 타이머 시작
            gameInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    endLostBeeGame(false);
                }
                
                // 충돌 검사
                if (checkCollision()) {
                    clearInterval(gameInterval);
                    endLostBeeGame(true);
                }
            }, 1000);
            
            // 방향키 이벤트 (길치이므로 반대로 동작)
            document.getElementById('leftBtn').onclick = () => moveBee('right');
            document.getElementById('upBtn').onclick = () => moveBee('down');
            document.getElementById('rightBtn').onclick = () => moveBee('left');
            document.getElementById('downBtn').onclick = () => moveBee('up');
            
            function moveBee(direction) {
                if (gameState.lostBeeGameEnded) return;
                
                const moveDistance = 8; // 퍼센트
                
                switch(direction) {
                    case 'left':
                        beePosition.x = Math.max(0, beePosition.x - moveDistance);
                        break;
                    case 'right':
                        beePosition.x = Math.min(85, beePosition.x + moveDistance);
                        break;
                    case 'up':
                        beePosition.y = Math.max(0, beePosition.y - moveDistance);
                        break;
                    case 'down':
                        beePosition.y = Math.min(85, beePosition.y + moveDistance);
                        break;
                }
                
                beeEl.style.left = beePosition.x + '%';
                beeEl.style.top = beePosition.y + '%';
            }
            
            function checkCollision() {
                const beeRect = beeEl.getBoundingClientRect();
                const hiveRect = hiveEl.getBoundingClientRect();
                
                return !(beeRect.right < hiveRect.left || 
                        beeRect.left > hiveRect.right || 
                        beeRect.bottom < hiveRect.top || 
                        beeRect.top > hiveRect.bottom);
            }
        }

        function endLostBeeGame(success) {
            if (gameState.lostBeeGameEnded) return;
            gameState.lostBeeGameEnded = true;
            
            // 길치 꿀벌 게임 음악 정지
            stopLostBeeGameSound();
            
            if (success) {
                playPositiveSound(); // 길치 꿀벌 게임 성공 → positive.mp3
                showResultAnimation(true, () => {
                    const successTexts = [
                        "다행히 이번 비행에서는 어떻게든 집으로 돌아왔다. 집 가는 길을 찾아라 미션 성공!",
                        "꿀벌 개체군은 안정적으로 유지되었다.",
                        "[효과] 꿀벌 개체수 0% 감소"
                    ];
                    
                    gameState.historyEvents.push(`${gameState.currentYear}년차: 집 가는 길 찾기 성공으로 꿀벌 지켜내기 성공`);
                    showEventResults(successTexts, true);
                });
            } else {
                playNegativeSound(); // 길치 꿀벌 게임 실패 → negative.mp3
                showResultAnimation(false, () => {
                    const failTexts = [
                        "농약의 신경계 교란 성분 때문에 집으로 돌아가는 데 실패하고 말았다...",
                        "많은 꿀벌들이 집으로 돌아오지 못하고 행방불명이 되어갔다..ㅠㅠ",
                        "[효과] 꿀벌 개체수 60% 감소"
                    ];
                    
                    gameState.population *= 0.4;
                    gameState.historyEvents.push(`${gameState.currentYear}년차: 집 가는 길 찾기 실패로 인해 꿀벌 개체수 60% 감소`);
                    showEventResults(failTexts, false);
                });
            }
        }

        // 게임 결과 애니메이션 표시
        function showResultAnimation(isSuccess, callback) {
            const animationEl = document.createElement('div');
            animationEl.className = `result-animation ${isSuccess ? 'success' : 'failure'}`;
            animationEl.textContent = isSuccess ? '🎉생존 성공!🎉' : '☠ 꿀벌 절멸...☠ ';
            
            document.querySelector('.game-container').appendChild(animationEl);
            
            setTimeout(() => {
                animationEl.remove();
                if (callback) callback();
            }, 2000);
        }

        // 이벤트 결과 표시
        function showEventResults(texts, isPositive) {
            let currentTextIndex = 0;
            
            function showNextText() {
                if (currentTextIndex < texts.length) {
                    eventTextEl.className = isPositive ? 'event-text positive' : 'event-text negative';
                    typeText(eventTextEl, texts[currentTextIndex], () => {
                        currentTextIndex++;
                        if (currentTextIndex < texts.length) {
                            eventActionsEl.innerHTML = `<button class="event-next-btn" onclick="showNextText()">▼</button>`;
                        } else {
                            eventActionsEl.innerHTML = `<button class="event-next-btn" onclick="closeEvent()">완료</button>`;
                        }
                    });
                }
            }
            
            window.showNextText = showNextText;
            window.closeEvent = () => {
                eventModalEl.style.display = 'none';
                
                simulateEcosystem();
                
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else if (gameState.currentYear >= 10) {
                    showSuccessEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
            };
            
            showNextText();
        }

        // 절멸 엔딩
        function showExtinctionEnding() {
            gameState.gameEnded = true;
            characterEl.style.backgroundImage = "url('images/bee_dead.png')";
            
            playFailureSound();
            showResultAnimation(false, () => {
                typeText(dialogueTextEl, `우리 꿀벌 개체군은 ${gameState.currentYear}년차에 역사 속으로 사라지게 되었어... ㅠㅠ `, () => {
                    dialogueActionsEl.innerHTML = `
                        <button class="action-btn secondary" onclick="restartGame()">재도전</button>
                        <button class="action-btn danger" onclick="goToMain()">메인 화면</button>
                        <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
                    `;
                    document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
                });
            });
        }

        // 성공 엔딩
        function showSuccessEnding() {
            gameState.gameEnded = true;
            characterEl.style.backgroundImage = "url('images/bee_wow.png')";
            
            playSuccessSound();
            showResultAnimation(true, () => {
                typeText(dialogueTextEl, "고마워! 네 덕분에 우리 꿀벌 개체군은 10년 동안 안정적인 개체군을 유지할 수 있었어!", () => {
                    dialogueActionsEl.innerHTML = `
                        <button class="action-btn" onclick="goToMain()">메인 화면</button>
                        <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
                    `;
                    document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
                }, 'dialogue-text success');
            });
        }

        // 디스플레이 업데이트
        function updateDisplay() {
            yearDisplayEl.textContent = `${gameState.currentYear}년차`;
            populationDisplayEl.textContent = `개체수: ${Math.floor(gameState.population)}마리`;
            plantADisplayEl.textContent = `밀원식물A: ${Math.floor(gameState.plantA)}그루`;
            plantBDisplayEl.textContent = `밀원식물B: ${Math.floor(gameState.plantB)}그루`;
        }

        // 버튼 활성화/비활성화
        function enableButtons() {
            graphBtnEl.disabled = false;
        }

        function disableButtons() {
            graphBtnEl.disabled = true;
        }

        // 로딩 표시
        function showLoading() {
            loadingOverlayEl.style.display = 'flex';
            typeText(document.getElementById('loadingText'), '번식 중...');
        }

        function hideLoading() {
            loadingOverlayEl.style.display = 'none';
        }

        // 그래프 표시
        function showGraph() {
            if (!gameState.dialogueComplete) return;

            graphModalEl.style.display = 'flex';
            
            setTimeout(() => {
                const canvas = document.getElementById('graphCanvas');
                const ctx = canvas.getContext('2d');
                
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                const width = rect.width;
                const height = rect.height;
                const padding = 80;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;
                
                // 배경
                ctx.fillStyle = '#fafbfc';
                ctx.fillRect(0, 0, width, height);
                
                // 최대값 계산
                const maxPop = Math.max(...gameState.populationHistory);
                const maxPlantA = Math.max(...gameState.plantAHistory);
                const maxPlantB = Math.max(...gameState.plantBHistory);
                const maxYear = gameState.populationHistory.length - 1;
                
                // 격자선
                ctx.strokeStyle = '#e8ecf0';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 8; i++) {
                    const y = padding + (i / 8) * graphHeight;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();
                }
                
                for (let i = 0; i <= maxYear; i++) {
                    const x = padding + (i / maxYear) * graphWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, height - padding);
                    ctx.stroke();
                }
                
                // 축
                ctx.strokeStyle = '#2d3748';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
                // 꿀벌 개체수 선 (파란색)
                if (gameState.populationHistory.length > 1) {
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i < gameState.populationHistory.length; i++) {
                        const x = padding + (i / maxYear) * graphWidth;
                        const y = height - padding - (gameState.populationHistory[i] / maxPop) * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // 밀원식물A 선 (녹색)
                if (gameState.plantAHistory.length > 1) {
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i < gameState.plantAHistory.length; i++) {
                        const x = padding + (i / maxYear) * graphWidth;
                        const y = height - padding - (gameState.plantAHistory[i] / Math.max(maxPlantA, maxPlantB)) * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // 밀원식물B 선 (주황색)
                if (gameState.plantBHistory.length > 1) {
                    ctx.strokeStyle = '#f59e0b';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i < gameState.plantBHistory.length; i++) {
                        const x = padding + (i / maxYear) * graphWidth;
                        const y = height - padding - (gameState.plantBHistory[i] / Math.max(maxPlantA, maxPlantB)) * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // 레이블
                ctx.fillStyle = '#4a5568';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                // X축 레이블
                for (let i = 0; i <= maxYear; i++) {
                    const x = padding + (i / maxYear) * graphWidth;
                    ctx.fillText(`${i}년`, x, height - padding + 20);
                }
                
                // Y축 레이블 (왼쪽 - 꿀벌)
                ctx.textAlign = 'right';
                ctx.fillStyle = '#3b82f6';
                for (let i = 0; i <= 8; i++) {
                    const y = height - padding - (i / 8) * graphHeight;
                    const value = Math.round((i / 8) * maxPop);
                    ctx.fillText(`${value}`, padding - 10, y + 4);
                }
                
                // 범례
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(width / 2 - 120, 30, 20, 3);
                ctx.fillStyle = '#4a5568';
                ctx.textAlign = 'left';
                ctx.fillText('꿀벌 개체수', width / 2 - 95, 35);
                
                ctx.fillStyle = '#10b981';
                ctx.fillRect(width / 2 - 120, 50, 20, 3);
                ctx.fillStyle = '#4a5568';
                ctx.fillText('밀원식물A', width / 2 - 95, 55);
                
                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(width / 2 - 120, 70, 20, 3);
                ctx.fillStyle = '#4a5568';
                ctx.fillText('밀원식물B', width / 2 - 95, 75);
            }, 100);
        }

        // 히스토리 표시
        function showHistory() {
            if (!gameState.dialogueComplete) return;

            historyModalEl.style.display = 'flex';
            
            let historyText = '';
            for (let i = 0; i < gameState.populationHistory.length; i++) {
                historyText += `${i}년차: 꿀벌 ${Math.floor(gameState.populationHistory[i])}마리`;
                if (gameState.plantAHistory[i] !== undefined) {
                    historyText += `, 밀원식물A ${Math.floor(gameState.plantAHistory[i])}그루`;
                }
                if (gameState.plantBHistory[i] !== undefined) {
                    historyText += `, 밀원식물B ${Math.floor(gameState.plantBHistory[i])}그루`;
                }
                historyText += '\n';
            }
            
            // 이벤트 히스토리 추가
            if (gameState.historyEvents.length > 0) {
                historyText += '\n=== 주요 사건 ===\n';
                gameState.historyEvents.forEach(event => {
                    historyText += event + '\n';
                });
            }
            
            historyContentEl.textContent = historyText;
        }

        // 모달 닫기
        function hideGraph() {
            graphModalEl.style.display = 'none';
        }

        function hideHistory() {
            historyModalEl.style.display = 'none';
        }

        // 게임 재시작/종료
        function restartGame() {
            location.reload();
        }

        function goToMain() {
            window.location.href = 'intro.html';
        }

        function goBack() {
            window.location.href = 'game.html';
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
            disableButtons();
            
            // 첫 번째 대사 시작하고 dialogueStep 증가
            typeText(dialogueTextEl, initialDialogues[0]);
            gameState.dialogueStep = 1;
            
            // 이벤트 리스너
            backBtnEl.addEventListener('click', goBack);
            graphBtnEl.addEventListener('click', showGraph);
            document.getElementById('closeGraphBtn').addEventListener('click', hideGraph);
            document.getElementById('closeHistoryBtn').addEventListener('click', hideHistory);
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
        });
    </script>
</body>
</html>