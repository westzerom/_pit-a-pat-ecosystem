<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소나무 Easy - 두근두근 개체군 키우기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #2d5016 0%, #4a7c59 50%, #6b9080 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.03) 0px,
                rgba(255, 255, 255, 0.03) 2px,
                transparent 2px,
                transparent 12px
            );
            pointer-events: none;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-container {
            width: 100vw;
            height: 56.25vw;
            max-width: 1280px;
            max-height: 720px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2em;
            box-shadow: 
                0 0 0 3px rgba(255, 255, 255, 0.2),
                0 1.5em 4em rgba(0, 0, 0, 0.2),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(0.6em);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: calc(1vw + 0.5vh);
        }

        @media (min-width: 1280px) {
            .game-container {
                font-size: 16px;
            }
        }

        @media screen and (min-aspect-ratio: 16/9) {
            .game-container {
                width: 177.78vh;
                height: 100vh;
            }
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1em 2em;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(0.3em);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(0, 0, 0, 0.15);
        }

        .status-info {
            display: flex;
            gap: 1em;
            align-items: center;
        }

        .status-display {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5em 1em;
            border-radius: 1em;
            font-weight: 700;
            color: #2D3748;
            font-size: 0.9em;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .graph-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 0.8em;
            padding: 0.5em 1em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            box-shadow: 0 0.25em 0.75em rgba(72, 187, 120, 0.3);
        }

        .graph-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(72, 187, 120, 0.4);
        }

        .graph-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .character-area {
            position: absolute;
            top: 4em;
            bottom: 4em;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1em 2em;
			
			/* 배경 이미지 추가 */
			background-image: url('images/tree_background.png');
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
        }

        .character {
            width: 18em;
            height: 18em;
            background-image: url('images/tree_main.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            animation: sway 3s ease-in-out infinite;
            filter: drop-shadow(0 0.4em 1em rgba(0, 0, 0, 0.15));
            transition: background-image 0.5s ease;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-1deg); }
            75% { transform: rotate(1deg); }
        }

        .dialogue-container {
            position: absolute;
            bottom: 2em;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5em 1.5em 1.5em 1.5em;
            padding: 1.5em;
            box-shadow: 
                0 -0.4em 1.2em rgba(0, 0, 0, 0.1),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
        }

        .dialogue-text {
            font-size: 1em;
            line-height: 1.5;
            color: #2D3748;
            margin-bottom: 1em;
            min-height: 3.5em;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .dialogue-text.success {
            color: #22c55e;
            font-weight: 600;
        }

        .dialogue-actions {
            display: flex;
            gap: 0.8em;
            justify-content: flex-end;
            align-items: center;
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0.3em 0.8em rgba(102, 126, 234, 0.3),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.2);
        }

        .next-btn:hover:not(:disabled) {
            transform: translateY(-0.12em) scale(1.05);
            box-shadow: 
                0 0.75em 1.5em rgba(102, 126, 234, 0.4),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.3);
        }
        
        .next-btn:disabled {
            cursor: not-allowed;
            background: #ccc;
        }

        .action-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 1.2em;
            padding: 0.8em 1.5em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            box-shadow: 0 0.37em 0.9em rgba(72, 187, 120, 0.3);
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.5em 1.2em rgba(72, 187, 120, 0.4);
        }

        .action-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            box-shadow: 0 0.37em 0.9em rgba(159, 122, 234, 0.3);
        }

        .action-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 0.5em 1.2em rgba(159, 122, 234, 0.4);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            box-shadow: 0 0.37em 0.9em rgba(229, 62, 62, 0.3);
        }

        .action-btn.danger:hover:not(:disabled) {
            box-shadow: 0 0.5em 1.2em rgba(229, 62, 62, 0.4);
        }

        /* 입력창 스타일 */
        .input-container {
            display: flex;
            align-items: center;
            gap: 0.5em;
            margin: 1em 0;
            flex-wrap: wrap;
        }

        .input-field {
            padding: 0.5em;
            border: 2px solid #cbd5e0;
            border-radius: 0.5em;
            font-size: 1em;
            width: 6em;
            text-align: center;
        }

        .confirm-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            border: none;
            border-radius: 0.8em;
            padding: 0.5em 1em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .confirm-btn:hover {
            transform: translateY(-0.06em);
        }

        /* 이벤트 모달 */
        .event-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .event-content {
            background: white;
            padding: 2em;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
            width: 90%;
            max-width: 35em;
            max-height: 80%;
        }

        .event-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #2D3748;
            margin-bottom: 1.5em;
            min-height: 4em;
        }

        .event-text.positive {
            color: #2563eb;
        }

        .event-text.negative {
            color: #dc2626;
        }

        .event-next-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 50%;
            width: 3em;
            height: 3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .event-next-btn:hover {
            transform: scale(1.1);
        }

        .choice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 1em;
            padding: 1em 1.5em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            margin: 0.5em;
            width: calc(100% - 1em);
            text-align: left;
        }

        .choice-btn:hover {
            transform: translateY(-0.06em);
            box-shadow: 0 0.5em 1.2em rgba(102, 126, 234, 0.4);
        }

        /* 그래프 모달 */
        .graph-modal, .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .history-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .graph-content, .loading-content {
            background: white;
            padding: 2em;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .graph-content { 
            width: 90%; 
            max-width: 35em; 
            max-height: 80%;
        }
        
        .loading-content { 
            text-align: center; 
            font-size: 2em; 
            font-weight: 700; 
            color: #2D3748; 
            padding: 2em;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
        }

        .graph-title { 
            font-size: 1.3em; 
            font-weight: 700; 
            color: #2D3748; 
        }

        .close-btn {
            background: #e53e3e; 
            border: none; 
            border-radius: 50%; 
            width: 2em; 
            height: 2em;
            color: white; 
            cursor: pointer; 
            font-size: 1.2em; 
            transition: all 0.3s ease;
        }
        
        .close-btn:hover { 
            background: #c53030; 
            transform: scale(1.1); 
        }

        .history-content {
            max-height: 300px; 
            overflow-y: auto; 
            padding: 1em; 
            background: #f7fafc; 
            border-radius: 0.5em; 
            font-family: monospace; 
            line-height: 1.5;
            white-space: pre-line;
        }

        .typing-cursor { 
            animation: blink 1s infinite; 
        }
        
        @keyframes blink { 
            0%, 50% { opacity: 1; } 
            51%, 100% { opacity: 0; } 
        }

        /* 게임 결과 애니메이션 */
        .result-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: 900;
            text-align: center;
            z-index: 100;
            animation: resultPop 2s ease-out;
            pointer-events: none;
        }

        .result-animation.success {
            color: #22c55e;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .result-animation.failure {
            color: #ef4444;
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        @keyframes resultPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1.1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="status-bar">
            <button class="back-btn" id="backBtn">←</button>
            <div class="status-info" id="statusInfo">
                <div class="status-display" id="yearDisplay">0년차</div>
                <div class="status-display" id="populationDisplay">개체수: 50그루</div>
                <div class="status-display" id="sunlightDisplay">햇빛: -</div>
                <div class="status-display" id="oakDisplay">참나무: -그루</div>
                <button class="graph-btn" id="graphBtn" disabled>개체수 그래프</button>
            </div>
        </div>

        <div class="character-area" id="characterArea">
            <div class="character" id="character"></div>
        </div>

        <div class="dialogue-container" id="dialogueContainer">
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-actions" id="dialogueActions">
                <button class="next-btn" id="nextBtn">🔽</button>
            </div>
        </div>

        <!-- 이벤트 모달 -->
        <div class="event-modal" id="eventModal">
            <div class="event-content">
                <div class="event-text" id="eventText"></div>
                <div id="eventActions">
                    <button class="event-next-btn" id="eventNextBtn">▼</button>
                </div>
            </div>
        </div>

        <!-- 그래프 모달 -->
        <div class="graph-modal" id="graphModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">개체수 변화 그래프</div>
                    <button class="close-btn" id="closeGraphBtn">×</button>
                </div>
                <canvas class="graph-canvas" id="graphCanvas" style="width: 100%; height: 20em; border: 1px solid #e2e8f0; border-radius: 0.5em;"></canvas>
            </div>
        </div>

        <!-- 히스토리 모달 -->
        <div class="history-modal" id="historyModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">히스토리</div>
                    <button class="close-btn" id="closeHistoryBtn">×</button>
                </div>
                <div class="history-content" id="historyContent"></div>
            </div>
        </div>

        <!-- 로딩 모달 -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content" id="loadingText">시간이 흐르고 있어...</div>
        </div>
    </div>

    <script>
        // 게임 상태
        let gameState = {
            currentYear: 0,
            population: 50,
            sunlight: 0,
            oak: 0,
            populationHistory: [50],
            sunlightHistory: [],
            oakHistory: [],
            historyEvents: [],
            dialogueStep: 0,
            isTyping: false,
            gameEnded: false,
            dialogueComplete: false,
            pendingBonus: null // 2년차 선택지 2 효과를 위한 변수
        };

        // DOM 요소들
        const dialogueTextEl = document.getElementById('dialogueText');
        const dialogueActionsEl = document.getElementById('dialogueActions');
        const characterEl = document.getElementById('character');
        const yearDisplayEl = document.getElementById('yearDisplay');
        const populationDisplayEl = document.getElementById('populationDisplay');
        const sunlightDisplayEl = document.getElementById('sunlightDisplay');
        const oakDisplayEl = document.getElementById('oakDisplay');
        const graphBtnEl = document.getElementById('graphBtn');
        const backBtnEl = document.getElementById('backBtn');
        const eventModalEl = document.getElementById('eventModal');
        const eventTextEl = document.getElementById('eventText');
        const eventActionsEl = document.getElementById('eventActions');
        const graphModalEl = document.getElementById('graphModal');
        const historyModalEl = document.getElementById('historyModal');
        const loadingOverlayEl = document.getElementById('loadingOverlay');
        const historyContentEl = document.getElementById('historyContent');

        // 초기 대사
        const initialDialogues = [
            "솔솔솔. 나는 소나무야.",
            "다른 식물들처럼, 나는 햇빛을 흡수해 광합성을 통해 필요한 양분을 합성해.",
            "나는 광포화점과 보상점이 높은 편이라, 빛이 센 환경일수록 유리해.",
            "요즘 우리 동네에 참나무라는 신참 나무들이 자라고 있는데…걔네는 광포화점과 보상점이 낮아서 괜찮으려나 몰라~",
            "아무튼, 우리 개체군은 계속 성장해나갈 수 있을까?",
            "우리 소나무 개체군은 지금 50그루가 있어.",
            "지금은 내가 우리 지역에서 가장 키가 커서, 햇빛을 많이 받을 수 있어.",
            "햇빛을 많이 받는 게 500, 적게 받는 게 10이라 치면 지금 나는 햇빛을 어느 정도 받고 있다고 할래?"
        ];

        // 효과음 함수
        const audioFiles = {
            positive: new Audio('audio/positive.mp3'),
            negative: new Audio('audio/negative.mp3'),
            success: new Audio('audio/success.mp3'),
            failure: new Audio('audio/failure.mp3')
        };

        // 모든 오디오 파일 미리 로드
        Object.values(audioFiles).forEach(audio => {
            audio.preload = 'auto';
        });

        // 효과음 재생 함수들
        function playPositiveSound() {
            audioFiles.positive.currentTime = 0;
            audioFiles.positive.play().catch(e => console.log('긍정 효과음 재생 오류:', e));
        }

        function playNegativeSound() {
            audioFiles.negative.currentTime = 0;
            audioFiles.negative.play().catch(e => console.log('부정 효과음 재생 오류:', e));
        }

        function playSuccessSound() {
            audioFiles.success.currentTime = 0;
            audioFiles.success.play().catch(e => console.log('성공 효과음 재생 오류:', e));
        }

        function playFailureSound() {
            audioFiles.failure.currentTime = 0;
            audioFiles.failure.play().catch(e => console.log('실패 효과음 재생 오류:', e));
        }

        // 타이핑 애니메이션
        function typeText(element, text, callback, className = '') {
            if (gameState.isTyping) return;
            
            gameState.isTyping = true;
            if (className) {
                element.className = className;
            }
            element.innerHTML = '';
            let i = 0;
            const cursor = '<span class="typing-cursor">|</span>';
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + cursor;
                    i++;
                    setTimeout(type, 50);
                } else {
                    element.innerHTML = text;
                    gameState.isTyping = false;
                    if (callback) callback();
                }
            }
            type();
        }

        // 대사 진행
        function nextDialogue() {
            if (gameState.isTyping) return;
            
            if (gameState.dialogueStep < initialDialogues.length) {
                typeText(dialogueTextEl, initialDialogues[gameState.dialogueStep], () => {
                    // 햇빛 설정 대화 후
                    if (gameState.dialogueStep === initialDialogues.length) {
                        showSunlightInput();
                    }
                });
                gameState.dialogueStep++;
            } else if (gameState.dialogueStep === initialDialogues.length) {
                // 햇빛 설정 후
                const afterSunlightText = `그러면 지금 햇빛은 ${gameState.sunlight} 정도구나!`;
                typeText(dialogueTextEl, afterSunlightText, () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 1) {
                typeText(dialogueTextEl, "방금 말했던 아기 참나무들은 몇 그루 정도 자라고 있을까?", () => {
                    showOakInput();
                });
                gameState.dialogueStep++;
            } else if (gameState.dialogueStep === initialDialogues.length + 2) {
                // 참나무 설정 후
                const afterOakText = `참나무는 ${gameState.oak}그루 정도 있구나!`;
                typeText(dialogueTextEl, afterOakText, () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 3) {
                typeText(dialogueTextEl, "어떤 어려움이 찾아올지 모르겠지만, 내 나무생의 목표는!", () => {
                    gameState.dialogueStep++;
                });
            } else if (gameState.dialogueStep === initialDialogues.length + 4) {
                typeText(dialogueTextEl, "우리 소나무 개체군이 안정적으로 잘 유지되는 거야. 그럴 수 있도록 도와줘! 잘 부탁해!", () => {
                    gameState.dialogueComplete = true;
                    showGameActions();
                    enableButtons();
                });
            }
        }

        // 햇빛 입력창 표시
        function showSunlightInput() {
            dialogueActionsEl.innerHTML = `
                <div class="input-container">
                    <span>햇빛 세기:</span>
                    <input type="number" id="sunlightInput" class="input-field" min="300" max="500" placeholder="300-500">
                    <button class="confirm-btn" onclick="setSunlightLevel()">확인</button>
                </div>
            `;
            // nextBtn이 존재하는지 확인 후 숨기기
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.style.display = 'none';
            }
        }

        // 햇빛 수준 설정
        function setSunlightLevel() {
            const sunlightInput = document.getElementById('sunlightInput');
            const value = parseInt(sunlightInput.value);
            
            if (isNaN(value) || value < 300 || value > 500) {
                alert('300~500 범위 내에서 설정해주세요!');
                return;
            }
            
            gameState.sunlight = value;
            gameState.sunlightHistory = [value];
            updateDisplay();
            
            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">📽</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            nextDialogue();
        }

        // 참나무 입력창 표시
        function showOakInput() {
            dialogueActionsEl.innerHTML = `
                <div class="input-container">
                    <span>참나무 개체수:</span>
                    <input type="number" id="oakInput" class="input-field" min="1" max="500" placeholder="1-500">
                    <button class="confirm-btn" onclick="setOakCount()">확인</button>
                </div>
            `;
            // nextBtn이 존재하는지 확인 후 숨기기
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.style.display = 'none';
            }
        }

        // 참나무 개체수 설정
        function setOakCount() {
            const oakInput = document.getElementById('oakInput');
            const value = parseInt(oakInput.value);
            
            if (isNaN(value) || value < 1 || value > 500) {
                alert('1~500 범위 내에서 설정해주세요!');
                return;
            }
            
            gameState.oak = value;
            gameState.oakHistory = [value];
            updateDisplay();
            
            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">📽</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            nextDialogue();
        }

        // 게임 액션 버튼 표시
        function showGameActions() {
            dialogueActionsEl.innerHTML = `
                <button class="action-btn" id="nextYearBtn">1년 후~</button>
                <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
            `;
            document.getElementById('nextYearBtn').addEventListener('click', nextYear);
            document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
        }

        // 1년 진행
        function nextYear() {
            if (!gameState.dialogueComplete || gameState.gameEnded) return;
            
            showLoading();
            setTimeout(() => {
                gameState.currentYear++;
                
                // 2년차 선택지 보너스 적용
                if (gameState.currentYear === 4 && gameState.pendingBonus) {
                    gameState.population *= 1.2; // 20% 증가
                    gameState.historyEvents.push(`${gameState.currentYear}년차: 규칙성 분포 효과로 소나무 개체수 20% 증가`);
                    gameState.pendingBonus = null;
                }
                
                // 이벤트 확인
                if (gameState.currentYear === 2) {
                    hideLoading();
                    showCompetitionEvent();
                    return;
                } else if (gameState.currentYear === 4) {
                    hideLoading();
                    showOakGrowthEvent();
                    return;
                } else if (gameState.currentYear === 7) {
                    hideLoading();
                    showOakDominanceEvent();
                    return;
                }
                
                // 기본 생태계 시뮬레이션
                simulateEcosystem();
                
                // 게임 종료 조건 확인
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else if (gameState.currentYear >= 10) {
                    showSuccessEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
                hideLoading();
            }, 1500);
        }

        // 생태계 시뮬레이션
        function simulateEcosystem() {
            const prevPopulation = gameState.population;
            
            // 기본 성장률
            const growthRate = 1.6;
            
            // 햇빛에 따른 성장 계산
            // 햇빛이 1000-햇빛값보다 크면 성장, 작으면 감소
            
            if (gameState.sunlight > 300) {
                // 소나무 개체수 증가
                gameState.population = Math.min(1000, gameState.population * growthRate);
                // 참나무 개체수 감소 (지수적)
                gameState.oak = Math.max(0, gameState.oak * 0.8);
            } else {
                // 소나무 개체수 감소
                gameState.population = Math.max(0, gameState.population * 0.7);
                // 참나무 개체수 증가 (지수적)
                gameState.oak = Math.min(1000, gameState.oak * 1.4);
                
                // 햇빛 부족으로 인한 위기 히스토리 추가
                gameState.historyEvents.push(`${gameState.currentYear}년차: 햇빛 부족으로 개체군 위기`);
            }
            
            // 히스토리 업데이트
            gameState.populationHistory.push(gameState.population);
            gameState.sunlightHistory.push(gameState.sunlight);
            gameState.oakHistory.push(gameState.oak);
        }

        // 연차별 대사 표시
        function showYearlyDialogue() {
            const currentPop = Math.floor(gameState.population);
            const prevPop = Math.floor(gameState.populationHistory[gameState.currentYear - 1] || currentPop);
            
            let dialogue = `지금은 ${gameState.currentYear}년차고, 우리 소나무 개체군은 ${currentPop}그루가 되었어.`;
            
            if (currentPop >= prevPop) {
                dialogue += " 다행히 아직 우리 소나무 개체군은 잘 살아있어. 앞으로도 잘 부탁해.";
                characterEl.style.backgroundImage = "url('images/tree_happy.png')";
            } else {
                dialogue += " 나는 아직 살아있지만.. 친구와 가족들을 조금 잃었어. 🥺";
                characterEl.style.backgroundImage = "url('images/tree_sad.png')";
            }
            
            // 대사 타이핑 중에는 버튼 비활성화
            dialogueActionsEl.innerHTML = '';
            
            typeText(dialogueTextEl, dialogue, () => {
                // 타이핑이 완전히 끝난 후 약간의 지연을 두고 버튼 활성화
                setTimeout(() => {
                    showGameActions();
                }, 200);
            });
        }

        // 2년차 경쟁 이벤트
        function showCompetitionEvent() {
            eventModalEl.style.display = 'flex';
            
            typeText(eventTextEl, "광합성이 잘 이뤄지기 위해서는 지상부의 햇빛뿐만 아니라 지하부의 물도 공급받아야 한다. 너무 많은 식물들이 좁은 땅에 몰려있으면 모두에게 손해가 크다. 어떻게 해야 할까?", () => {
                eventActionsEl.innerHTML = `
                    <button class="choice-btn" onclick="chooseAllelopathy()">뿌리에서 타감작용 물질인 갈로탄닌을 분비한다.</button>
                    <button class="choice-btn" onclick="chooseDistribution()">뿌리를 적당히 뻗어 다른 소나무와의 적정한 거리를 확보한다.</button>
                `;
            });
        }

        // 타감작용 선택
        function chooseAllelopathy() {
            playPositiveSound();
            gameState.population *= 1.15; // 15% 증가
            gameState.historyEvents.push(`${gameState.currentYear}년차: 타감작용으로 종간경쟁을 해소해 소나무 개체수 15% 증가`);
            
            const successTexts = [
                "타감작용을 통해 주변에 다른 식물들이 못 자라게 막았다!",
                "[효과] 소나무 개체수 15% 증가"
            ];
            
            showEventResults(successTexts, true, () => {
                // 기본 생태계 시뮬레이션 실행
                simulateEcosystem();
                
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
            });
        }

        // 규칙적 분포 선택
        function chooseDistribution() {
            playPositiveSound();
            gameState.pendingBonus = true; // 2년 후(4년차) 효과 예약
            gameState.historyEvents.push(`${gameState.currentYear}년차: 규칙성 분포로 종내경쟁을 해소, 2년 후 소나무 개체수 20% 증가 예정`);
            
            const successTexts = [
                "규칙적인 분포를 통해 토양 속 물 자원을 나눠가졌다.",
                "같은 소나무끼리 오손도손 사이좋게 지내자~",
                "[효과] 2년 후 소나무 개체수 20% 증가"
            ];
            
            showEventResults(successTexts, true, () => {
                // 기본 생태계 시뮬레이션 실행
                simulateEcosystem();
                
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
            });
        }

        // 4년차 참나무 성장 이벤트
        function showOakGrowthEvent() {
            eventModalEl.style.display = 'flex';
            playNegativeSound();
            
            const eventTexts = [
                "신참이었던 참나무들이 눈 깜짝할 새에 무럭무럭 자라버렸다!",
                "아니…낮은 곳은 그늘이 져서 빛의 세기가 약했을 텐데 어떻게 자랐지?",
                "아무튼 이제는 우리 소나무 개체군보다 키가 커져버린 참나무들이 잎으로 햇빛을 가리기 시작했다.",
                "광합성량이 줄어서 예전처럼 배부르게 양분을 합성하지는 못할 듯하다.",
                "[효과] 햇빛 크기 30% 감소"
            ];
            
            // 햇빛 30% 감소
            gameState.sunlight *= 0.7;
            gameState.historyEvents.push(`${gameState.currentYear}년차: 참나무가 자라서 혼합림을 형성함`);
            
            showEventResults(eventTexts, false, () => {
                // 기본 생태계 시뮬레이션 실행
                simulateEcosystem();
                
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
            });
        }

        // 7년차 참나무 우세 이벤트
        function showOakDominanceEvent() {
            eventModalEl.style.display = 'flex';
            playNegativeSound();
            
            const eventTexts = [
                "꼬르륵…아 너무 배고파.",
                "키가 큰 참나무들이 훨씬 많아져서 소나무들 위를 무성하게 덮어버렸다.",
                "어른 소나무들은 그나마 괜찮은데, 아기 소나무들은 햇빛 양이 부족해 생장하기 어려움을 겪는 듯하다.",
                "아…햇빛 혼자 쓰나….ㅠㅠ",
                "[효과] 햇빛 크기 30% 감소"
            ];
            
            // 햇빛 30% 감소
            gameState.sunlight *= 0.7;
            gameState.historyEvents.push(`${gameState.currentYear}년차: 참나무가 자라서 양수림을 형성해감`);
            
            showEventResults(eventTexts, false, () => {
                // 기본 생태계 시뮬레이션 실행
                simulateEcosystem();
                
                if (gameState.population <= 5) {
                    showExtinctionEnding();
                } else {
                    showYearlyDialogue();
                }
                
                updateDisplay();
            });
        }

        // 이벤트 결과 표시
        function showEventResults(texts, isPositive, callback) {
            let currentTextIndex = 0;
            
            function showNextText() {
                if (currentTextIndex < texts.length) {
                    // 색상 클래스 적용
                    eventTextEl.className = isPositive ? 'event-text positive' : 'event-text negative';
                    typeText(eventTextEl, texts[currentTextIndex], () => {
                        currentTextIndex++;
                        if (currentTextIndex < texts.length) {
                            eventActionsEl.innerHTML = `<button class="event-next-btn" onclick="showNextText()">▼</button>`;
                        } else {
                            eventActionsEl.innerHTML = `<button class="event-next-btn" onclick="closeEvent()">완료</button>`;
                        }
                    });
                }
            }
            
            // 전역 함수로 등록
            window.showNextText = showNextText;
            window.closeEvent = () => {
                eventModalEl.style.display = 'none';
                if (callback) callback();
            };
            
            showNextText();
        }

        // 절멸 엔딩
        function showExtinctionEnding() {
            gameState.gameEnded = true;
            characterEl.style.backgroundImage = "url('images/tree_dead.png')";
            
            playFailureSound();
            showResultAnimation(false, () => {
                typeText(dialogueTextEl, `우리 소나무 개체군은 ${gameState.currentYear}년차에 역사 속으로 사라지게 되었어... ㅠㅠ`, () => {
                    dialogueActionsEl.innerHTML = `
                        <button class="action-btn secondary" onclick="restartGame()">재도전</button>
                        <button class="action-btn danger" onclick="goToMain()">메인 화면</button>
                        <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
                    `;
                    document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
                });
            });
        }

        // 성공 엔딩
        function showSuccessEnding() {
            gameState.gameEnded = true;
            characterEl.style.backgroundImage = "url('images/tree_wow.png')";
            
            playSuccessSound();
            showResultAnimation(true, () => {
                typeText(dialogueTextEl, "고마워! 네 덕분에 우리 소나무 개체군은 10년 동안 안정적인 개체군을 유지할 수 있었어!", () => {
                    dialogueActionsEl.innerHTML = `
                        <button class="action-btn" onclick="goToMain()">메인 화면</button>
                        <button class="next-btn" id="showHistoryBtn" title="히스토리">📋</button>
                    `;
                    document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
                }, 'dialogue-text success');
            });
        }

        // 게임 결과 애니메이션 표시
        function showResultAnimation(isSuccess, callback) {
            const animationEl = document.createElement('div');
            animationEl.className = `result-animation ${isSuccess ? 'success' : 'failure'}`;
            animationEl.textContent = isSuccess ? '🎉성장 성공!🎉' : '💔 소나무 절멸...💔';
            
            document.querySelector('.game-container').appendChild(animationEl);
            
            // 2초 후 제거하고 콜백 실행
            setTimeout(() => {
                animationEl.remove();
                if (callback) callback();
            }, 2000);
        }

        // 디스플레이 업데이트
        function updateDisplay() {
            yearDisplayEl.textContent = `${gameState.currentYear}년차`;
            populationDisplayEl.textContent = `개체수: ${Math.floor(gameState.population)}그루`;
            sunlightDisplayEl.textContent = `햇빛: ${Math.floor(gameState.sunlight)}`;
            oakDisplayEl.textContent = `참나무: ${Math.floor(gameState.oak)}그루`;
        }

        // 버튼 활성화/비활성화
        function enableButtons() {
            graphBtnEl.disabled = false;
        }

        function disableButtons() {
            graphBtnEl.disabled = true;
        }

        // 로딩 표시
        function showLoading() {
            loadingOverlayEl.style.display = 'flex';
            typeText(document.getElementById('loadingText'), '번식 중...');
        }

        function hideLoading() {
            loadingOverlayEl.style.display = 'none';
        }

        // 그래프 표시
        function showGraph() {
            if (!gameState.dialogueComplete) return;

            graphModalEl.style.display = 'flex';
            
            setTimeout(() => {
                const canvas = document.getElementById('graphCanvas');
                const ctx = canvas.getContext('2d');
                
                // 캔버스 크기 설정
                const rect = canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                
                const width = rect.width;
                const height = rect.height;
                const padding = 80;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;
                
                // 배경
                ctx.fillStyle = '#fafbfc';
                ctx.fillRect(0, 0, width, height);
                
                // 최대값 계산
                const maxPop = Math.max(...gameState.populationHistory);
                const maxOak = Math.max(...gameState.oakHistory);
                const maxYear = gameState.populationHistory.length - 1;
                
                // 격자선
                ctx.strokeStyle = '#e8ecf0';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 8; i++) {
                    const y = padding + (i / 8) * graphHeight;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();
                }
                
                for (let i = 0; i <= maxYear; i++) {
                    const x = padding + (i / maxYear) * graphWidth;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, height - padding);
                    ctx.stroke();
                }
                
                // 축
                ctx.strokeStyle = '#2d3748';
                ctx.lineWidth = 2;
                ctx.beginPath();
                // 왼쪽 Y축 (소나무)
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding, height - padding);
                // 오른쪽 Y축 (참나무)
                ctx.moveTo(width - padding, padding);
                ctx.lineTo(width - padding, height - padding);
                // X축
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
                // 소나무 개체수 선 (초록색, 왼쪽 축 기준)
                if (gameState.populationHistory.length > 1) {
                    ctx.strokeStyle = '#16a34a';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i < gameState.populationHistory.length; i++) {
                        const x = padding + (i / maxYear) * graphWidth;
                        const y = height - padding - (gameState.populationHistory[i] / maxPop) * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // 참나무 개체수 선 (갈색, 오른쪽 축 기준)
                if (gameState.oakHistory.length > 1) {
                    ctx.strokeStyle = '#a16207';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i < gameState.oakHistory.length; i++) {
                        const x = padding + (i / maxYear) * graphWidth;
                        const y = height - padding - (gameState.oakHistory[i] / maxOak) * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                }
                
                // 레이블
                ctx.fillStyle = '#4a5568';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                // X축 레이블
                for (let i = 0; i <= maxYear; i++) {
                    const x = padding + (i / maxYear) * graphWidth;
                    ctx.fillText(`${i}년`, x, height - padding + 20);
                }
                
                // 왼쪽 Y축 레이블 (소나무)
                ctx.textAlign = 'right';
                ctx.fillStyle = '#16a34a';
                for (let i = 0; i <= 8; i++) {
                    const y = height - padding - (i / 8) * graphHeight;
                    const value = Math.round((i / 8) * maxPop);
                    ctx.fillText(`${value}`, padding - 10, y + 4);
                }
                
                // 오른쪽 Y축 레이블 (참나무)
                ctx.textAlign = 'left';
                ctx.fillStyle = '#a16207';
                for (let i = 0; i <= 8; i++) {
                    const y = height - padding - (i / 8) * graphHeight;
                    const value = Math.round((i / 8) * maxOak);
                    ctx.fillText(`${value}`, width - padding + 10, y + 4);
                }
                
                // 범례
                ctx.fillStyle = '#16a34a';
                ctx.fillRect(width / 2 - 80, 30, 20, 3);
                ctx.fillStyle = '#4a5568';
                ctx.textAlign = 'left';
                ctx.fillText('소나무 개체수', width / 2 - 55, 35);
                
                ctx.fillStyle = '#a16207';
                ctx.fillRect(width / 2 - 80, 50, 20, 3);
                ctx.fillStyle = '#4a5568';
                ctx.fillText('참나무 개체수', width / 2 - 55, 55);
            }, 100);
        }

        // 히스토리 표시
        function showHistory() {
            if (!gameState.dialogueComplete) return;

            historyModalEl.style.display = 'flex';
            
            let historyText = '';
            for (let i = 0; i < gameState.populationHistory.length; i++) {
                historyText += `${i}년차: 소나무 ${Math.floor(gameState.populationHistory[i])}그루`;
                if (gameState.oakHistory[i] !== undefined) {
                    historyText += `, 참나무 ${Math.floor(gameState.oakHistory[i])}그루`;
                }
                if (gameState.sunlightHistory[i] !== undefined) {
                    historyText += `, 햇빛 ${Math.floor(gameState.sunlightHistory[i])}`;
                }
                historyText += '\n';
            }
            
            // 이벤트 히스토리 추가
            if (gameState.historyEvents.length > 0) {
                historyText += '\n=== 주요 사건 ===\n';
                gameState.historyEvents.forEach(event => {
                    historyText += event + '\n';
                });
            }
            
            historyContentEl.textContent = historyText;
        }

        // 모달 닫기
        function hideGraph() {
            graphModalEl.style.display = 'none';
        }

        function hideHistory() {
            historyModalEl.style.display = 'none';
        }

        // 게임 재시작/종료
        function restartGame() {
            location.reload();
        }

        function goToMain() {
            window.location.href = 'index.html';
        }

        function goBack() {
            window.location.href = 'game.html';
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
            disableButtons();
            
            // 첫 번째 대사 시작하고 dialogueStep 증가
            typeText(dialogueTextEl, initialDialogues[0]);
            gameState.dialogueStep = 1; // 다음 버튼 클릭 시 두 번째 대사부터 시작
            
            // 이벤트 리스너
            backBtnEl.addEventListener('click', goBack);
            graphBtnEl.addEventListener('click', showGraph);
            document.getElementById('closeGraphBtn').addEventListener('click', hideGraph);
            document.getElementById('closeHistoryBtn').addEventListener('click', hideHistory);
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
        });
    </script>
</body>
</html>