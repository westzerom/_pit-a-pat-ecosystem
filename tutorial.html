<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŠœí† ë¦¬ì–¼ - ë‘ê·¼ë‘ê·¼ ê°œì²´êµ° í‚¤ìš°ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 50%, #8e44ad 100%);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.05) 0px,
                rgba(255, 255, 255, 0.05) 2px,
                transparent 2px,
                transparent 12px
            );
            pointer-events: none;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-container {
            width: 100vw;
            height: 56.25vw;
            max-width: 1280px;
            max-height: 720px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 2em;
            box-shadow: 
                0 0 0 3px rgba(255, 255, 255, 0.2),
                0 1.5em 4em rgba(0, 0, 0, 0.2),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(0.6em);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: calc(1vw + 0.5vh);
        }

        @media (min-width: 1280px) {
            .game-container {
                font-size: 16px;
            }
        }

        /* ì„¸ë¡œê°€ ë” ê¸´ í™”ë©´ì¼ ë•Œ */
        @media screen and (min-aspect-ratio: 16/9) {
            .game-container {
                width: 177.78vh;
                height: 100vh;
            }
        }

        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1em 2em;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(0.3em);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .back-btn:hover {
            background: white;
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(0, 0, 0, 0.15);
        }

        .status-info {
            display: flex;
            gap: 1em;
            align-items: center;
            transition: visibility 0s, opacity 0.3s linear;
        }

        .population-display {
            background: rgba(255, 255, 255, 0.9);
            padding: 0.5em 1em;
            border-radius: 1em;
            font-weight: 700;
            color: #2D3748;
            font-size: 0.9em;
            box-shadow: 0 0.25em 0.75em rgba(0, 0, 0, 0.1);
        }

        .graph-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 0.8em;
            padding: 0.5em 1em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            box-shadow: 0 0.25em 0.75em rgba(72, 187, 120, 0.3);
        }

        .graph-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.37em 1em rgba(72, 187, 120, 0.4);
        }

        .graph-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .character-area {
            position: absolute;
            top: 4em;
            bottom: 8em;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1em 2em;
        }

        .character {
            width: 18em;
            height: 18em;
            background-image: url('images/otter_main.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            animation: bounce 2s ease-in-out infinite;
            filter: drop-shadow(0 0.4em 1em rgba(0, 0, 0, 0.15));
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) rotate(0deg); }
            40% { transform: translateY(-0.8em) rotate(-2deg); }
            60% { transform: translateY(-0.4em) rotate(1deg); }
        }

        .dialogue-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 1.5em 1.5em 0 0;
            padding: 1.5em;
            min-height: 8em;
            box-shadow: 
                0 -0.4em 1.2em rgba(0, 0, 0, 0.1),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.7);
        }

        .dialogue-text {
            font-size: 1em;
            line-height: 1.5;
            color: #2D3748;
            margin-bottom: 1em;
            min-height: 3.5em;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .dialogue-actions {
            display: flex;
            gap: 0.8em;
            justify-content: flex-end;
            align-items: center;
        }

        .next-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 2.5em;
            height: 2.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 0.3em 0.8em rgba(102, 126, 234, 0.3),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.2);
        }

        .next-btn:hover:not(:disabled) {
            transform: translateY(-0.12em) scale(1.05);
            box-shadow: 
                0 0.75em 1.5em rgba(102, 126, 234, 0.4),
                inset 0 0.06em 0 rgba(255, 255, 255, 0.3);
        }
        
        .next-btn:disabled {
            cursor: not-allowed;
            background: #ccc;
        }

        .action-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 1.2em;
            padding: 0.8em 1.5em;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            box-shadow: 0 0.37em 0.9em rgba(72, 187, 120, 0.3);
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-0.06em);
            box-shadow: 0 0.5em 1.2em rgba(72, 187, 120, 0.4);
        }

        .action-btn:disabled {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            box-shadow: 0 0.37em 0.9em rgba(159, 122, 234, 0.3);
        }

        .action-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 0.5em 1.2em rgba(159, 122, 234, 0.4);
        }
        
        .mode-selection {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2em;
            gap: 1em;
            background: rgba(255, 255, 255, 0.95);
            z-index: 20;
        }

        .mode-selection.active {
            display: flex;
        }

        .mode-selection h2 {
            text-align: center;
            color: #2D3748;
            margin-bottom: 1em;
            font-size: 1.5em;
        }
        
        .mode-selection > .mode-btn,
        .mode-selection > .action-btn {
            width: 60%;
            max-width: 300px;
        }

        .mode-btn {
            background: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);
            border: none;
            border-radius: 1.5em;
            padding: 1.2em 2em;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            position: relative;
            overflow: hidden;
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .mode-btn:hover::before {
            left: 100%;
        }

        .mode-btn:hover {
            transform: translateY(-0.12em);
            box-shadow: 0 0.6em 1.5em rgba(237, 100, 166, 0.4);
        }

        .mode-btn.lab {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .mode-btn.lab:hover {
            box-shadow: 0 0.6em 1.5em rgba(102, 126, 234, 0.4);
        }

        .graph-modal, .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .history-modal {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 2em;
        }

        .graph-content, .loading-content {
            background: white;
            padding: 2em;
            border-radius: 1.5em;
            box-shadow: 0 1.2em 2.4em rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .graph-content { 
            width: 90%; 
            max-width: 35em; 
            max-height: 80%;
        }
        
        .loading-content { 
            text-align: center; 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #2D3748; 
            padding: 3em; 
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5em;
        }

        .graph-title { 
            font-size: 1.3em; 
            font-weight: 700; 
            color: #2D3748; 
        }

        .close-btn {
            background: #e53e3e; 
            border: none; 
            border-radius: 50%; 
            width: 2em; 
            height: 2em;
            color: white; 
            cursor: pointer; 
            font-size: 1.2em; 
            transition: all 0.3s ease;
        }
        
        .close-btn:hover { 
            background: #c53030; 
            transform: scale(1.1); 
        }

        .history-content {
            max-height: 300px; 
            overflow-y: auto; 
            padding: 1em; 
            background: #f7fafc; 
            border-radius: 0.5em; 
            font-family: monospace; 
            line-height: 1.5;
            white-space: pre-line;
        }

        .typing-cursor { 
            animation: blink 1s infinite; 
        }
        
        @keyframes blink { 
            0%, 50% { opacity: 1; } 
            51%, 100% { opacity: 0; } 
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="status-bar">
            <button class="back-btn" id="backBtn">ğŸ </button>
            <div class="status-info" id="statusInfo">
                <div class="population-display" id="populationDisplay">ê°œì²´ìˆ˜: 50ë§ˆë¦¬</div>
                <button class="graph-btn" id="graphBtn" disabled>ê°œì²´ìˆ˜ ê·¸ë˜í”„</button>
            </div>
        </div>

        <div class="character-area" id="characterArea">
            <div class="character" id="character"></div>
        </div>

        <div class="dialogue-container" id="dialogueContainer">
            <div class="dialogue-text" id="dialogueText">ë€¨ë€¨. ì•ˆë…• ë‚˜ëŠ” ê·€ì—¬ìš´ í•´ë‹¬ì´ì•¼.</div>
            <div class="dialogue-actions" id="dialogueActions">
                <button class="next-btn" id="nextBtn">ğŸ”½</button>
            </div>
        </div>

        <div class="mode-selection" id="modeSelection">
            <h2>ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!</h2>
            <button class="mode-btn" data-mode="surreal">ğŸŒŸ ì´ˆí˜„ì‹¤ ëª¨ë“œ</button>
            <button class="mode-btn lab" data-mode="lab">ğŸ”¬ ì‹¤í—˜ì‹¤ ëª¨ë“œ</button>
            <button class="action-btn secondary" id="goToMainBtn" style="margin-top: 1em;">ë©”ì¸ ë©”ë‰´ë¡œ</button>
        </div>

        <div class="graph-modal" id="graphModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">ê°œì²´ìˆ˜ ë³€í™” ê·¸ë˜í”„</div>
                    <button class="close-btn" id="closeGraphBtn">Ã—</button>
                </div>
                <canvas class="graph-canvas" id="graphCanvas" style="width: 100%; height: 20em; border: 1px solid #e2e8f0; border-radius: 0.5em;"></canvas>
            </div>
        </div>

        <div class="history-modal" id="historyModal">
             <div class="graph-content">
                <div class="graph-header">
                    <div class="graph-title">íˆìŠ¤í† ë¦¬</div>
                    <button class="close-btn" id="closeHistoryBtn">Ã—</button>
                </div>
                <div class="history-content" id="historyContent"></div>
            </div>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content" id="loadingText">ë²ˆì‹ ì¤‘...</div>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œë“¤
        const dialogueTextEl = document.getElementById('dialogueText');
        const dialogueActionsEl = document.getElementById('dialogueActions');
        const dialogueContainerEl = document.getElementById('dialogueContainer');
        const modeSelectionEl = document.getElementById('modeSelection');
        const statusInfoEl = document.getElementById('statusInfo');
        const populationDisplayEl = document.getElementById('populationDisplay');
        const graphBtnEl = document.getElementById('graphBtn');
        const characterAreaEl = document.getElementById('characterArea');
        const graphModalEl = document.getElementById('graphModal');
        const historyModalEl = document.getElementById('historyModal');
        const loadingOverlayEl = document.getElementById('loadingOverlay');
        const loadingTextEl = document.getElementById('loadingText');
        const backBtnEl = document.getElementById('backBtn');
        const historyContentEl = document.getElementById('historyContent');

        // ê²Œì„ ìƒíƒœ
        let gameState = {
            currentStep: 0,
            currentYear: 0,
            population: 50,
            populationHistory: [50],
            currentMode: null,
            dialogueStep: 0,
            isTyping: false,
            dialogueComplete: false
        };

        // ëŒ€ì‚¬ ë°ì´í„°
        const tutorialDialogues = [
            "ë€¨ë€¨. ì•ˆë…• ë‚˜ëŠ” ê·€ì—¬ìš´ í•´ë‹¬ì´ì•¼.", 
            "ê°œì²´êµ°ì€ í•œ ì§€ì—­ì—ì„œ ê°™ì€ ì¢…ì˜ ìƒë¬¼ì´ ë¬´ë¦¬ë¥¼ ì´ë£¬ ì§‘ë‹¨ì„ ë§í•´.", 
            "ìš°ë¦¬ í•´ë‹¬ ê°œì²´êµ°ì´ ì‹œê°„ì— ë”°ë¼ ì–¼ë§ˆë‚˜ ì„±ì¥í•˜ëŠ”ì§€ ë³¼ë˜?", 
            "ë‹¤ìŒ í™”ë©´ì—ì„œ ëª¨ë“œë¥¼ ì„ íƒí•´ì¤˜!"
        ];
        
        const supernaturalDialogues = [
            "ë€¨ë€¨. ë‚˜ëŠ” ê·€ì—¬ìš´ í•´ë‹¬ì´ê³  ì—¬ê¸´ ì´ˆí˜„ì‹¤ ì„¸ìƒì´ì•¼.", 
            "ë¬´í•œí•œ ë¨¹ì´ì™€ ë¬´í•œí•œ ê³µê°„!", 
            "ì´ˆí˜„ì‹¤ ì„¸ìƒì—ì„œ ìš°ë¦¬ í•´ë‹¬ ê°œì²´êµ°ì€ ê³„ì† ì„±ì¥í•´ë‚˜ê°ˆ ìˆ˜ ìˆì–´.", 
            "ì§€ê¸ˆ í•´ë‹¬ ê°œì²´êµ°ì€ 50ë§ˆë¦¬ ìˆì–´.", 
            "ì‹œê°„ì´ íë¦„ì— ë”°ë¼ ìš°ë¦¬ í•´ë‹¬ ê°œì²´êµ°ì´ ì–´ë–»ê²Œ ì„±ì¥í•˜ëŠ”ì§€ ë³¼ë˜?", 
            "ì‹œê°„ì„ íë¥´ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ '1ë…„ í›„~' ë²„íŠ¼ì„ í´ë¦­í•˜ê³ ,", 
            "ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ 'ê°œì²´ìˆ˜ ê·¸ë˜í”„' ë²„íŠ¼ì„ í´ë¦­í•´ì¤˜."
        ];
        
        const labDialogues = [
            "ë€¨ë€¨. ë‚˜ëŠ” ê·€ì—¬ìš´ í•´ë‹¬ì´ê³  ì—¬ê¸´ ì‹¤í—˜ì‹¤ ì„¸ìƒì´ì•¼.", 
            "ë¬´í•œí•œ ë¨¹ì´! í•˜ì§€ë§Œ ì‹¤í—˜ì‹¤ì´ê¸° ë•Œë¬¸ì— ê³µê°„ì´ ìœ í•œí•´...", 
            "ê³¼ì—° ì‹¤í—˜ì‹¤ ì„¸ìƒì—ì„œë„ ìš°ë¦¬ëŠ” ì—„ì²­ë‚œ ì†ë„ë¡œ ì„±ì¥í•´ë‚˜ê°ˆ ìˆ˜ ìˆì„ê¹Œ?", 
            "ì§€ê¸ˆ í•´ë‹¬ ê°œì²´êµ°ì€ 50ë§ˆë¦¬ ìˆì–´.", 
            "ì‹œê°„ì´ íë¦„ì— ë”°ë¼ ìš°ë¦¬ í•´ë‹¬ ê°œì²´êµ°ì´ ì–´ë–»ê²Œ ì„±ì¥í•˜ëŠ”ì§€ ë³¼ë˜?", 
            "ì‹œê°„ì„ íë¥´ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ '1ë…„ í›„~' ë²„íŠ¼ì„ í´ë¦­í•˜ê³ ,", 
            "ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ 'ê°œì²´ìˆ˜ ê·¸ë˜í”„' ë²„íŠ¼ì„ í´ë¦­í•´ì¤˜."
        ];
        
        function setActionButtonsState(disabled) {
            dialogueActionsEl.querySelectorAll('button').forEach(button => {
                button.disabled = disabled;
            });
        }

        function typeText(element, text, callback) {
            if (gameState.isTyping) return;
            gameState.isTyping = true;
            setActionButtonsState(true);

            element.innerHTML = '';
            let i = 0;
            const cursor = '<span class="typing-cursor">|</span>';
            
            function type() {
                if (i < text.length) {
                    element.innerHTML = text.substring(0, i + 1) + cursor;
                    i++;
                    setTimeout(type, 50);
                } else {
                    element.innerHTML = text;
                    gameState.isTyping = false;
                    setActionButtonsState(false);
                    if (callback) callback();
                }
            }
            type();
        }

        function nextDialogue() {
            if (gameState.isTyping) return;
            
            if (gameState.currentStep === 0) {
                gameState.dialogueStep++;
                if (gameState.dialogueStep < tutorialDialogues.length) {
                    typeText(dialogueTextEl, tutorialDialogues[gameState.dialogueStep]);
                } else {
                    showModeSelection();
                }
            } else {
                const dialogues = gameState.currentMode === 'surreal' ? supernaturalDialogues : labDialogues;
                gameState.dialogueStep++;
                
                if (gameState.dialogueStep < dialogues.length) {
                    typeText(dialogueTextEl, dialogues[gameState.dialogueStep]);
                } else {
                    gameState.dialogueComplete = true;
                    showGameActions();
                    enableButtons();
                }
            }
        }

        function enableButtons() { 
            graphBtnEl.disabled = false; 
        }
        
        function disableButtons() { 
            graphBtnEl.disabled = true; 
        }

        function showModeSelection() {
            dialogueContainerEl.style.display = 'none';
            modeSelectionEl.classList.add('active');
            characterAreaEl.style.display = 'none';
        }

        function startMode(mode) {
            gameState.currentMode = mode;
            gameState.currentStep = 1;
            gameState.dialogueStep = 0;
            gameState.dialogueComplete = false;
            
            modeSelectionEl.classList.remove('active');
            dialogueContainerEl.style.display = 'block';
            characterAreaEl.style.display = 'flex';
            statusInfoEl.style.visibility = 'visible';
            backBtnEl.textContent = 'â†';
            
            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">ğŸ”½</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);

            const dialogues = mode === 'surreal' ? supernaturalDialogues : labDialogues;
            typeText(dialogueTextEl, dialogues[0]);
            
            updateDisplay();
            disableButtons();
        }

        function showGameActions() {
            dialogueActionsEl.innerHTML = `<button class="action-btn" id="nextYearBtn">1ë…„ í›„~</button><button class="next-btn" id="showHistoryBtn" title="íˆìŠ¤í† ë¦¬">ğŸ“‹</button>`;
            document.getElementById('nextYearBtn').addEventListener('click', nextYear);
            document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
        }

        function nextYear() {
            if (!gameState.dialogueComplete) return;
            showLoading();
            setTimeout(() => {
                gameState.currentYear++;
                
                if (gameState.currentMode === 'surreal') {
                    gameState.population *= 1.6;
                } else if (gameState.currentMode === 'lab') {
                    const r = 0.8; 
                    const K = 500; 
                    const N = gameState.population;
                    const growthRate = r * (1 - N / K);
                    gameState.population += (growthRate * N);
                    if (gameState.population > K) gameState.population = K;
                }
                
                gameState.populationHistory.push(gameState.population);
                updateDisplay();
                updateCharacterExpression();
                hideLoading();
                showYearlyDialogue();
            }, 1500);
        }

        function showYearlyDialogue() {
            let dialogue;
            const pop = Math.floor(gameState.population);
            const prevPop = gameState.populationHistory[gameState.currentYear - 1] || pop;

            if (gameState.currentMode === 'surreal') {
                if (gameState.currentYear >= 10) {
                    dialogue = `í—¤í—¤. ì§€ê¸ˆ ìš°ë¦¬ëŠ” ${pop}ë§ˆë¦¬ ìˆì–´. ë¬´í•œí•œ ë¨¹ì´ì™€ ë¬´í•œí•œ ê³µê°„ ì†ì—ì„œ ìš°ë¦¬ëŠ” ì„±ì¥í–ˆì–´. ì´ˆí˜„ì‹¤ ì„¸ìƒì—ì„œì˜ ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³¼ ë§Œí¼ ë³¸ ê²ƒ ê°™ë‹¤ë©´, 'ë‹¤ë¥¸ ëª¨ë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ëª¨ë“œë¥¼ í”Œë ˆì´í•´ë´.`;
                } else {
                    dialogue = `í—¤í—¤. ì§€ê¸ˆ ìš°ë¦¬ëŠ” ${pop}ë§ˆë¦¬ ìˆì–´. ë¬´í•œí•œ ë¨¹ì´ì™€ ë¬´í•œí•œ ê³µê°„ ì†ì—ì„œ ìš°ë¦¬ëŠ” ì„±ì¥í–ˆì–´.`;
                }
            } else {
                const growthRate = pop / prevPop;
                if (gameState.currentYear >= 10) {
                    if (pop >= 495) {
                        dialogue = `ê°œì²´êµ° í¬ê¸°ê°€ ${pop}ë§ˆë¦¬ë¡œ... ë” ì´ìƒ ëŠ˜ì–´ë‚˜ì§€ ì•ŠëŠ” ê²ƒ ê°™ì•„. ê³µê°„ì˜ í•œê³„ì¸ê°€ë´. ì‹¤í—˜ì‹¤ ì„¸ìƒì—ì„œì˜ ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³¼ ë§Œí¼ ë³¸ ê²ƒ ê°™ë‹¤ë©´, 'ë‹¤ë¥¸ ëª¨ë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ëª¨ë“œë¥¼ í”Œë ˆì´í•´ë´.`;
                        updateCharacterExpression('concern');
                    } else if (growthRate < 1.1) {
                        dialogue = `ê°œì²´êµ° í¬ê¸°ê°€ ${pop}ë§ˆë¦¬ë¡œ ì»¤ì§€ê¸´ í–ˆëŠ”ë°... ì„±ì¥ ì†ë„ê°€ ì ì  ëŠë ¤ì§€ëŠ” ê²ƒ ê°™ì§€? ì‹¤í—˜ì‹¤ ì„¸ìƒì—ì„œì˜ ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³¼ ë§Œí¼ ë³¸ ê²ƒ ê°™ë‹¤ë©´, 'ë‹¤ë¥¸ ëª¨ë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ëª¨ë“œë¥¼ í”Œë ˆì´í•´ë´.`;
                        updateCharacterExpression('concern');
                    } else {
                        dialogue = `í—¤í—¤. ì§€ê¸ˆ ìš°ë¦¬ëŠ” ${pop}ë§ˆë¦¬ ìˆì–´. ê³„ì† ì„±ì¥í•˜ê³  ìˆì–´! ì‹¤í—˜ì‹¤ ì„¸ìƒì—ì„œì˜ ê°œì²´ìˆ˜ ë³€í™”ë¥¼ ë³¼ ë§Œí¼ ë³¸ ê²ƒ ê°™ë‹¤ë©´, 'ë‹¤ë¥¸ ëª¨ë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ëª¨ë“œë¥¼ í”Œë ˆì´í•´ë´.`;
                    }
                } else {
                    if (pop >= 495) {
                        dialogue = `ê°œì²´êµ° í¬ê¸°ê°€ ${pop}ë§ˆë¦¬ë¡œ... ë” ì´ìƒ ëŠ˜ì–´ë‚˜ì§€ ì•ŠëŠ” ê²ƒ ê°™ì•„. ê³µê°„ì˜ í•œê³„ì¸ê°€ë´.`;
                        updateCharacterExpression('concern');
                    } else if (growthRate < 1.1 && gameState.currentYear > 1) {
                        dialogue = `ê°œì²´êµ° í¬ê¸°ê°€ ${pop}ë§ˆë¦¬ë¡œ ì»¤ì§€ê¸´ í–ˆëŠ”ë°... ì„±ì¥ ì†ë„ê°€ ì ì  ëŠë ¤ì§€ëŠ” ê²ƒ ê°™ì§€?`;
                        updateCharacterExpression('concern');
                    } else {
                        dialogue = `í—¤í—¤. ì§€ê¸ˆ ìš°ë¦¬ëŠ” ${pop}ë§ˆë¦¬ ìˆì–´. ê³„ì† ì„±ì¥í•˜ê³  ìˆì–´!`;
                    }
                }
            }
            
            typeText(dialogueTextEl, dialogue, handleDialogueEnd);
        }

        function handleDialogueEnd() {
            if (gameState.currentYear >= 10) {
                 dialogueActionsEl.innerHTML = `
                    <button class="action-btn secondary" id="resetBtn">ë‹¤ë¥¸ ëª¨ë“œ</button>
                    <button class="action-btn" id="nextYearBtn">1ë…„ í›„~</button>
                    <button class="next-btn" id="showHistoryBtn" title="íˆìŠ¤í† ë¦¬">ğŸ“‹</button>`;
                document.getElementById('resetBtn').addEventListener('click', resetGame);
                document.getElementById('nextYearBtn').addEventListener('click', nextYear);
                document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
            } else {
                showGameActions();
            }
        }

        function updateCharacterExpression(mood = 'normal') {
            characterAreaEl.querySelector('.character').style.filter = mood === 'concern' 
                ? 'drop-shadow(0 0.4em 1em rgba(0, 0, 0, 0.15)) sepia(0.3) hue-rotate(340deg)' 
                : 'drop-shadow(0 0.4em 1em rgba(0, 0, 0, 0.15))';
        }

        function updateDisplay() {
            populationDisplayEl.textContent = `${gameState.currentYear}ë…„ì°¨ - ${Math.floor(gameState.population)}ë§ˆë¦¬`;
        }

        function showLoading() {
            loadingOverlayEl.style.display = 'flex';
            typeText(loadingTextEl, 'ë²ˆì‹ ì¤‘...');
        }
        
        function hideLoading() { 
            loadingOverlayEl.style.display = 'none'; 
        }

        function showGraph() {
    if (!gameState.dialogueComplete) return;

    graphModalEl.style.display = 'flex';
    
    setTimeout(() => {
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        
        // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì‹¤ì œ í‘œì‹œ í¬ê¸°ì— ë§ì¶¤ (ê³ í•´ìƒë„ ëŒ€ì‘)
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        
        const width = rect.width;
        const height = rect.height;
        const padding = 60;
        const graphWidth = width - 2 * padding;
        const graphHeight = height - 2 * padding;
        
        // ë°°ê²½ ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#fafbfc';
        ctx.fillRect(0, 0, width, height);
        
        // ìµœëŒ€ê°’ ì°¾ê¸°
        const maxPop = gameState.currentMode === 'lab' ? 
            Math.max(...gameState.populationHistory, 500 + 50) : 
            Math.max(...gameState.populationHistory);
        const maxYear = gameState.populationHistory.length - 1;
        
        // ê²©ìì„  ê·¸ë¦¬ê¸°
        ctx.strokeStyle = '#e8ecf0';
        ctx.lineWidth = 1;
        
        // ì„¸ë¡œ ê²©ìì„  (ì—°ë„)
        const yearSteps = Math.min(10, maxYear || 1);
        for (let i = 0; i <= yearSteps; i++) {
            const x = padding + (i / yearSteps) * graphWidth;
            ctx.beginPath();
            ctx.moveTo(x, padding);
            ctx.lineTo(x, height - padding);
            ctx.stroke();
        }
        
        // ê°€ë¡œ ê²©ìì„  (ê°œì²´ìˆ˜)
        const popSteps = 8;
        for (let i = 0; i <= popSteps; i++) {
            const y = padding + (i / popSteps) * graphHeight;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
        }
        
        // ì‹¤í—˜ì‹¤ ëª¨ë“œ: í™˜ê²½ìˆ˜ìš©ë ¥ ì„  ê·¸ë¦¬ê¸°
        if (gameState.currentMode === 'lab') {
            const K = 500;
            const kY = height - padding - (K / maxPop) * graphHeight;
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.setLineDash([8, 4]);
            ctx.beginPath();
            ctx.moveTo(padding, kY);
            ctx.lineTo(width - padding, kY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // í™˜ê²½ìˆ˜ìš©ë ¥ ë¼ë²¨
            ctx.fillStyle = '#ff6b6b';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(`í™˜ê²½ìˆ˜ìš©ë ¥ (${K}ë§ˆë¦¬)`, padding + 10, kY - 8);
        }
        
        // ì¶• ê·¸ë¦¬ê¸°
        ctx.strokeStyle = '#2d3748';
        ctx.lineWidth = 2;
        ctx.beginPath();
        // Yì¶•
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        // Xì¶•
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();
        
        // ë°ì´í„° ì ë“¤ê³¼ ì„  ê·¸ë¦¬ê¸°
        if (gameState.populationHistory.length > 1) {
            // ê·¸ë¼ë””ì–¸íŠ¸ ìƒì„±
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            if (gameState.currentMode === 'lab') {
                gradient.addColorStop(0, '#38a169');
                gradient.addColorStop(1, '#68d391');
            } else {
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#9f7aea');
            }
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            
            for (let i = 0; i < gameState.populationHistory.length; i++) {
                const x = padding + (i / maxYear) * graphWidth;
                const y = height - padding - (gameState.populationHistory[i] / maxPop) * graphHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // ë°ì´í„° ì  ê·¸ë¦¬ê¸°
            const pointColor = gameState.currentMode === 'lab' ? '#38a169' : '#667eea';
            for (let i = 0; i < gameState.populationHistory.length; i++) {
                const x = padding + (i / maxYear) * graphWidth;
                const y = height - padding - (gameState.populationHistory[i] / maxPop) * graphHeight;
                
                // ì  ë°°ê²½ (í°ìƒ‰)
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // ì  í…Œë‘ë¦¬
                ctx.strokeStyle = pointColor;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // ì  ë‚´ë¶€
                ctx.fillStyle = pointColor;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
        
        // ì¶• ë ˆì´ë¸” ë° ëˆˆê¸ˆ ê°’
        ctx.fillStyle = '#4a5568';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        
        // Xì¶• ë ˆì´ë¸” (ì—°ë„)
        const yearStep = Math.max(1, Math.floor(maxYear / 8));
        for (let i = 0; i <= maxYear; i += yearStep) {
            const x = padding + (i / (maxYear || 1)) * graphWidth;
            ctx.fillText(`${i}ë…„`, x, height - padding + 20);
        }
        
        // Yì¶• ë ˆì´ë¸” (ê°œì²´ìˆ˜)
        ctx.textAlign = 'right';
        for (let i = 0; i <= popSteps; i++) {
            const y = height - padding - (i / popSteps) * graphHeight;
            const value = Math.round((i / popSteps) * maxPop);
            ctx.fillText(`${value}`, padding - 15, y + 4);
        }
        
        // ì¶• ì œëª©
        ctx.fillStyle = '#2d3748';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        
        // Xì¶• ì œëª©
        ctx.fillText('ì—°ë„', width / 2, height - 10);
        
        // Yì¶• ì œëª©
        ctx.save();
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('ê°œì²´ìˆ˜ (ë§ˆë¦¬)', 0, 0);
        ctx.restore();
    }, 100);
}

        function showHistory() {
            if (!gameState.dialogueComplete) return;

            historyModalEl.style.display = 'flex';
            
            let historyText = '';
            for (let i = 0; i < gameState.populationHistory.length; i++) {
                historyText += `${i}ë…„ì°¨: ${Math.floor(gameState.populationHistory[i])}ë§ˆë¦¬\n`;
            }
            
            historyContentEl.textContent = historyText;
        }

        function hideGraph() { 
            graphModalEl.style.display = 'none'; 
        }

        function hideHistory() { 
            historyModalEl.style.display = 'none'; 
        }
        
        function resetGame() { 
            resetInitialState(); 
            showModeSelection(); 
        }
        
        function goToMainMenu() { 
            window.location.href = 'index.html'; 
        }
        
        function goBackToTutorial() {
            resetInitialState();
        }
        
        function resetInitialState() {
            dialogueContainerEl.style.display = "block";
            modeSelectionEl.classList.remove('active');
            characterAreaEl.style.display = 'flex';
            statusInfoEl.style.visibility = 'hidden';
            backBtnEl.textContent = 'ğŸ ';

            dialogueActionsEl.innerHTML = `<button class="next-btn" id="nextBtn">ğŸ”½</button>`;
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            
            Object.assign(gameState, {
                currentStep: 0, currentYear: 0, population: 50, populationHistory: [50],
                currentMode: null, dialogueStep: 0, isTyping: false, dialogueComplete: false
            });
            updateDisplay();
            disableButtons();
            typeText(dialogueTextEl, tutorialDialogues[0]);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            backBtnEl.addEventListener('click', () => {
                if (backBtnEl.textContent === 'ğŸ ') {
                    goToMainMenu(); // í™ˆìœ¼ë¡œ
                } else {
                    goBackToTutorial(); // íŠœí† ë¦¬ì–¼ ì´ˆê¸°í™”ë©´ìœ¼ë¡œ
                }
            });
            
            graphBtnEl.addEventListener('click', showGraph);
            document.querySelectorAll('.mode-btn').forEach(button => {
                button.addEventListener('click', () => startMode(button.dataset.mode));
            });
            document.getElementById('goToMainBtn').addEventListener('click', goToMainMenu);
            document.getElementById('closeGraphBtn').addEventListener('click', hideGraph);
            document.getElementById('closeHistoryBtn').addEventListener('click', hideHistory);
            document.getElementById('nextBtn').addEventListener('click', nextDialogue);
            
            // ì´ˆê¸° ìƒíƒœ ì„¤ì •
            statusInfoEl.style.visibility = 'hidden';
            disableButtons();
        });
    </script>
</body>

</html>
